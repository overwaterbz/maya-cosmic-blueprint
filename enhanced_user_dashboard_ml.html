<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🌟 The Magic is You - Enhanced Dashboard</title>
    
    <!-- Three.js for Cosmic Particles -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="stylesheet" href="/static/css/cosmic-particles.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;600;700&family:Cinzel:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables for Phase 1 Consistency (SAFE - Adding only, not modifying existing) */
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --accent-gradient: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --background-gradient: linear-gradient(135deg, #fef7ed 0%, #fef3c7 25%, #fde68a 50%, #fbbf24 75%, #f59e0b 100%);
            --text-primary: #1e3a8a;
            --text-secondary: #8b4513;
            --border-color: rgba(139, 69, 19, 0.1);
            --white-transparent: rgba(255, 255, 255, 0.95);
            --shadow-standard: 0 10px 30px rgba(0, 0, 0, 0.1);
            --shadow-heavy: 0 20px 40px rgba(0, 0, 0, 0.1);
            --border-radius-standard: 1rem;
            --border-radius-large: 1.5rem;
            --border-radius-pill: 25px;
            --transition-standard: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #fef7ed 0%, #fef3c7 25%, #fde68a 50%, #fbbf24 75%, #f59e0b 100%);
            color: #1e3a8a;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Cosmic Particles Background */
        .cosmic-particles-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.2;
            pointer-events: none;
        }

        .cosmic-particles-interactive {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            opacity: 0.5;
            pointer-events: auto;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }

        .header {
            text-align: center;
            padding: 2rem 1rem;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        /* Phase 3 Enhanced Personalization Widgets */
        .phase3-widgets {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .daily-insights-widget {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1.5rem;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(139, 69, 19, 0.1);
        }

        .daily-insights-widget h3 {
            color: #8b4513;
            margin-bottom: 1rem;
            font-family: 'Playfair Display', serif;
            font-size: 1.4rem;
        }

        .insight-content {
            background: linear-gradient(135deg, #fef7ed 0%, #fef3c7 100%);
            padding: 1rem;
            border-radius: 1rem;
            margin-bottom: 1rem;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .cosmic-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .cosmic-info span {
            background: rgba(139, 69, 19, 0.1);
            padding: 0.3rem 0.8rem;
            border-radius: 1rem;
            font-size: 0.85rem;
            color: #8b4513;
            margin: 0.2rem;
        }

        .practices-list {
            list-style: none;
            padding: 0;
        }

        .practices-list li {
            background: rgba(245, 158, 11, 0.1);
            padding: 0.5rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.8rem;
            border-left: 3px solid #f59e0b;
            font-size: 0.9rem;
        }

        .guidance-request-widget {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1.5rem;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(139, 69, 19, 0.1);
        }

        .guidance-request-widget h3 {
            color: #8b4513;
            margin-bottom: 1rem;
            font-family: 'Playfair Display', serif;
            font-size: 1.4rem;
        }

        .guidance-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .guidance-form select,
        .guidance-form textarea {
            padding: 0.8rem;
            border: 2px solid rgba(139, 69, 19, 0.2);
            border-radius: 0.8rem;
            font-size: 0.9rem;
            background: rgba(255, 255, 255, 0.8);
        }

        .guidance-form textarea {
            resize: vertical;
            min-height: 80px;
        }

        .guidance-button {
            background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%);
            color: white;
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 0.8rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .guidance-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 69, 19, 0.3);
        }

        .guidance-response {
            background: linear-gradient(135deg, #fef7ed 0%, #fef3c7 100%);
            padding: 1rem;
            border-radius: 1rem;
            margin-top: 1rem;
            border-left: 4px solid #8b4513;
        }

        .loading-indicator {
            text-align: center;
            padding: 2rem;
            color: #8b4513;
        }

        .loading-spinner {
            border: 3px solid rgba(139, 69, 19, 0.3);
            border-top: 3px solid #8b4513;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .personalization-analytics {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1.5rem;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(139, 69, 19, 0.1);
            margin-bottom: 2rem;
        }

        .personalization-analytics h3 {
            color: #8b4513;
            margin-bottom: 1rem;
            font-family: 'Playfair Display', serif;
            font-size: 1.4rem;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #fef7ed 0%, #fef3c7 100%);
            padding: 1rem;
            border-radius: 1rem;
            text-align: center;
            border: 1px solid rgba(139, 69, 19, 0.1);
        }

        .stat-card h4 {
            color: #8b4513;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .stat-card span {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1e3a8a;
        }

        .logout-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 1.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        .logout-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        /* Promotional Banner */
        .promo-banner {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 1rem;
            text-align: center;
            margin-bottom: 1rem;
            border-radius: 1rem;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
            animation: pulse 2s infinite;
        }
        
        .promo-content h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.25rem;
            font-weight: bold;
        }
        
        .promo-content p {
            margin: 0.25rem 0;
            font-size: 0.9rem;
            opacity: 0.95;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3); }
            50% { box-shadow: 0 8px 35px rgba(16, 185, 129, 0.5); }
            100% { box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3); }
        }
        
        /* Header Navigation */
        .header-nav {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 1rem 0;
        }
        
        .nav-link {
            color: #5830a3;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            background: rgba(88, 48, 163, 0.1);
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .nav-link:hover {
            background: rgba(88, 48, 163, 0.2);
            transform: translateY(-2px);
        }

        .main-features-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .main-features-section h2 {
            text-align: center;
            font-size: 1.5rem;
            color: #5830a3;
            margin-bottom: 1.5rem;
            font-family: 'Cinzel', serif;
        }

        .main-feature-card {
            border-radius: 1.5rem;
            padding: 1.5rem;
            color: white;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
            touch-action: manipulation;
        }

        .main-feature-card:hover, .main-feature-card:active {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .main-feature-card h3 {
            font-size: 1.25rem;
            margin-bottom: 0.75rem;
            font-weight: 700;
        }

        .main-feature-card p {
            font-size: 0.9rem;
            line-height: 1.4;
            opacity: 0.9;
        }

        /* Mobile-responsive main features */
        @media (min-width: 640px) {
            .main-features-section {
                padding: 2rem;
                margin-bottom: 2rem;
            }
            
            .main-features-section h2 {
                font-size: 1.75rem;
                margin-bottom: 2rem;
            }
            
            .main-feature-card {
                padding: 2rem;
                margin-bottom: 0;
            }
            
            .main-feature-card h3 {
                font-size: 1.5rem;
                margin-bottom: 1rem;
            }
            
            .main-feature-card p {
                font-size: 1rem;
                line-height: 1.6;
            }
        }

        @media (min-width: 1024px) {
            .main-features-section {
                padding: 3rem;
                margin-bottom: 2.5rem;
            }
            
            .main-features-section h2 {
                font-size: 2rem;
                margin-bottom: 2.5rem;
            }
            
            .main-feature-card {
                padding: 2.5rem;
            }
            
            .main-feature-card h3 {
                font-size: 1.75rem;
                margin-bottom: 1.25rem;
            }
            
            .main-feature-card p {
                font-size: 1.125rem;
                line-height: 1.7;
            }
        }

        .header h1 {
            font-family: 'Cinzel', serif;
            font-size: 1.875rem;
            color: #1e3a8a;
            margin-bottom: 0.75rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Mobile-First Responsive Design */
        @media (min-width: 640px) {
            .header h1 {
                font-size: 2.5rem;
            }
            
            .dashboard-container {
                padding: 1.5rem;
            }
            
            .header {
                padding: 2.5rem 1.5rem;
            }
            
            .logout-button {
                top: 1.5rem;
                right: 1.5rem;
                padding: 0.75rem 1.5rem;
                font-size: 1rem;
            }
        }

        @media (min-width: 1024px) {
            .header h1 {
                font-size: 3rem;
            }
            
            .dashboard-container {
                padding: 2rem;
            }
            
            .header {
                padding: 3rem 2rem;
                margin-bottom: 2rem;
            }
            
            .logout-button {
                top: 2rem;
                right: 2rem;
                padding: 1rem 2rem;
                font-size: 1.125rem;
            }
        }

        .user-welcome {
            font-size: 1.2rem;
            color: #6366f1;
            margin-bottom: 20px;
        }

        .personalized-snapshot {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            line-height: 1.6;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .cosmic-elements-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .cosmic-elements-section h2 {
            text-align: center;
            font-size: 1.5rem;
            color: #5830a3;
            margin-bottom: 1.5rem;
            font-family: 'Cinzel', serif;
        }

        /* Mobile-responsive section styling */
        @media (min-width: 640px) {
            .cosmic-elements-section {
                padding: 2rem;
                margin-bottom: 2rem;
            }
            
            .cosmic-elements-section h2 {
                font-size: 1.75rem;
                margin-bottom: 2rem;
            }
        }

        @media (min-width: 1024px) {
            .cosmic-elements-section {
                padding: 3rem;
                margin-bottom: 2.5rem;
            }
            
            .cosmic-elements-section h2 {
                font-size: 2rem;
                margin-bottom: 2.5rem;
            }
        }

        /* Horizontal Layout - Matching Homepage Design */
        .cosmic-elements-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            margin-top: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .element-category {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(99, 102, 241, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 30px;
        }

        .element-category:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        .category-title {
            font-family: 'Cinzel', serif;
            font-size: 1.4rem;
            color: #1e3a8a;
            margin-bottom: 20px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #f59e0b;
            font-weight: 700;
        }

        .element-bubble {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border: 2px solid #d1d5db;
            border-radius: 1rem;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 0.75rem;
            touch-action: manipulation;
        }

        .element-bubble:hover, .element-bubble:active {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            border-color: #8b5cf6;
        }

        /* Mobile-responsive element bubbles */
        @media (min-width: 640px) {
            .element-bubble {
                padding: 1.25rem;
                border-radius: 1.25rem;
                margin-bottom: 1rem;
            }
            
            .element-bubble:hover, .element-bubble:active {
                transform: translateY(-3px);
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            }
        }

        @media (min-width: 1024px) {
            .element-bubble {
                padding: 1.5rem;
                border-radius: 1.5rem;
                margin-bottom: 1.25rem;
            }
        }

        .element-icon {
            font-size: 2.0rem;
            margin-bottom: 10px;
            opacity: 0.8;
        }

        .element-name {
            font-weight: 700;
            font-size: 1rem;
            color: #1e3a8a !important;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .element-value {
            font-size: 0.9rem;
            color: #5830a3 !important;
            margin-bottom: 0;
            position: relative;
            z-index: 1;
            font-weight: 600;
            line-height: 1.3;
        }

        .element-snapshot {
            display: none; /* Hide snapshots in bubble view */
        }

        .discover-button {
            display: none; /* Hide buttons in bubble view */
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .cosmic-elements-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .cosmic-elements-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .category-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 10px;
            }
        }

        @media (max-width: 480px) {
            .cosmic-elements-grid {
                grid-template-columns: 1fr;
            }
            
            .category-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
        }

        .modal-content {
            background: white;
            margin: 2% auto;
            padding: 1.5rem;
            border-radius: 1.5rem;
            width: 95%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.3);
        }

        /* Mobile-responsive modal */
        @media (min-width: 640px) {
            .modal-content {
                margin: 3% auto;
                padding: 2rem;
                width: 90%;
                max-height: 85vh;
            }
        }
        
        /* Enhanced mobile modal optimization */
        @media (max-width: 480px) {
            .modal-content {
                width: 98%;
                margin: 1% auto;
                padding: 1rem;
                border-radius: 1rem;
            }
            
            .modal-header {
                font-size: 1.5rem;
                padding-bottom: 1rem;
            }
            
            .modal-body {
                font-size: 1rem;
                line-height: 1.5;
            }
            
            .modal-close {
                top: 1rem;
                right: 1rem;
                width: 32px;
                height: 32px;
                font-size: 1.5rem;
            }
        }
        
        /* Spiritual Tools popup mobile styling */
        @media (max-width: 768px) {
            .popup-content {
                width: 95%;
                max-height: 85vh;
                padding: 1.5rem 1rem;
                margin: 2% auto;
            }
            
            .popup-button {
                width: 100%;
                margin-bottom: 1rem;
                min-height: 44px;
                padding: 14px 20px;
                font-size: 1.1rem;
            }
            
            .popup-title {
                font-size: 1.5rem;
                margin-bottom: 1rem;
            }
            
            .popup-description {
                font-size: 1rem;
                line-height: 1.6;
                margin-bottom: 1.5rem;
            }
        }
        
        /* Chat interface mobile optimization */
        @media (max-width: 768px) {
            .chat-popup {
                width: 100%;
                height: 100vh;
                border-radius: 0;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
            }
            
            .chat-input {
                min-height: 44px;
                font-size: 16px; /* Prevents iOS zoom */
                padding: 14px 16px;
            }
            
            .chat-send-button {
                min-height: 44px;
                min-width: 44px;
                padding: 10px;
            }
            
            .chat-messages {
                padding: 1rem;
                font-size: 1rem;
            }
        }

        @media (min-width: 1024px) {
            .modal-content {
                margin: 5% auto;
                padding: 3rem;
                width: 80%;
                max-height: 80vh;
            }
        }

        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #1e3a8a;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #f59e0b;
        }

        .modal-title {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            color: #1e3a8a;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-body {
            font-size: 1.1rem;
            line-height: 1.7;
            color: #1e3a8a;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
            flex-wrap: wrap;
        }

        .action-button {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            text-decoration: none;
            display: inline-block;
        }

        .action-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #1e3a8a;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #f59e0b;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .floating-elements {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .floating-element {
            position: absolute;
            opacity: 0.1;
            animation: float 20s infinite linear;
        }

        @keyframes float {
            0% {
                transform: translateY(100vh) rotate(0deg);
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
            }
        }

        /* Comprehensive Mobile-First Responsive Design */
        @media (max-width: 768px) {
            /* Dashboard Container */
            .dashboard-container {
                padding: 0.75rem;
            }
            
            /* Header */
            .header {
                padding: 1.5rem 0.75rem;
                margin-bottom: 1rem;
                border-radius: 1rem;
            }
            
            .header h1 {
                font-size: 1.5rem;
                margin-bottom: 0.5rem;
            }
            
            .logout-button {
                top: 0.75rem;
                right: 0.75rem;
                padding: 0.5rem 0.75rem;
                font-size: 0.75rem;
                border-radius: 1rem;
            }
            
            /* Main Features */
            .main-features-grid {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
                padding: 0 !important;
            }
            
            .main-feature-card {
                padding: 1.25rem !important;
                border-radius: 1rem;
            }
            
            .main-feature-card h3 {
                font-size: 1.125rem !important;
                margin-bottom: 0.5rem;
            }
            
            .main-feature-card p {
                font-size: 0.875rem !important;
                line-height: 1.4;
            }
            
            /* Cosmic Elements */
            .cosmic-elements-section {
                padding: 1rem;
                margin-bottom: 1rem;
                border-radius: 1rem;
            }
            
            .cosmic-elements-section h2 {
                font-size: 1.25rem;
                margin-bottom: 1rem;
            }
            
            .category-title {
                font-size: 1rem;
                margin-bottom: 0.75rem;
            }
            
            .element-bubble {
                padding: 0.75rem;
                min-height: 100px;
                border-radius: 0.75rem;
                margin-bottom: 0.5rem;
            }
            
            .element-icon {
                font-size: 1.5rem;
                margin-bottom: 0.5rem;
            }
            
            .element-name {
                font-size: 0.875rem;
                margin-bottom: 0.25rem;
            }
            
            .element-value {
                font-size: 0.75rem;
                line-height: 1.2;
            }
            
            /* Ix Chel Chat */
            .ix-chel-chat-card {
                padding: 1.5rem 1rem !important;
                border-radius: 1rem;
            }
            
            .ix-chel-chat-card h3 {
                font-size: 1.25rem !important;
                margin-bottom: 0.75rem;
            }
            
            .ix-chel-chat-card p {
                font-size: 0.875rem !important;
                line-height: 1.4;
            }
            
            /* Soul Intro */
            .soul-intro-compact {
                padding: 1rem !important;
                border-radius: 1rem;
            }
            
            .soul-intro-compact div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
                gap: 0.75rem !important;
                text-align: center !important;
            }
            
            .soul-essence-section, .cosmic-identity-section {
                padding: 0.75rem 0 !important;
            }
            
            /* Modals */
            .modal-content {
                margin: 1% auto;
                padding: 1rem;
                width: 98%;
                max-height: 95vh;
                border-radius: 1rem;
            }
            
            .modal h2 {
                font-size: 1.25rem;
                margin-bottom: 1rem;
            }
            
            .modal p {
                font-size: 0.875rem;
                line-height: 1.4;
            }
            
            /* Chat Elements */
            .chat-popup {
                width: 98%;
                max-height: 95vh;
                border-radius: 1rem;
            }
            
            .chat-header {
                padding: 1rem;
            }
            
            .chat-header h3 {
                font-size: 1.25rem;
            }
            
            .chat-header p {
                font-size: 0.75rem;
                margin-top: 0.5rem;
            }
            
            .chat-close {
                top: 0.75rem;
                right: 1rem;
                font-size: 1.25rem;
            }
            
            .chat-body {
                padding: 1rem;
                max-height: 65vh;
            }
            
            /* Touch-friendly interactions */
            .element-bubble, .main-feature-card, .floating-chat-button {
                touch-action: manipulation;
            }
            
            /* Better visibility for mobile */
            .cosmic-particles-container {
                opacity: 0.04;
            }
            
            .floating-hieroglyph {
                font-size: 1.25rem;
                animation-duration: 8s;
            }
            
            /* Spacing adjustments */
            .mb-12 {
                margin-bottom: 1.5rem;
            }
            
            .mb-8 {
                margin-bottom: 1rem;
            }
            
            .mb-6 {
                margin-bottom: 0.75rem;
            }
            
            .grid.gap-6 {
                gap: 0.75rem;
            }
            
            .grid.gap-4 {
                gap: 0.5rem;
            }
        }

        /* Floating Chat Button */
        .floating-chat-button {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%);
            padding: 0.75rem 1rem;
            border-radius: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 8px 30px rgba(139, 92, 246, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
            animation: pulse 2s infinite;
            border: none;
            outline: none;
            touch-action: manipulation;
        }

        .floating-chat-button:hover, .floating-chat-button:active {
            transform: scale(1.05);
            box-shadow: 0 12px 40px rgba(139, 92, 246, 0.6);
        }

        .floating-chat-button span {
            font-size: 1.5rem;
            color: white;
        }

        /* Mobile-responsive chat button */
        @media (min-width: 640px) {
            .floating-chat-button {
                bottom: 1.5rem;
                right: 1.5rem;
                padding: 1rem 1.25rem;
                border-radius: 2rem;
            }
            
            .floating-chat-button span {
                font-size: 1.75rem;
            }
            
            .floating-chat-button:hover {
                transform: scale(1.1);
            }
        }

        @media (min-width: 1024px) {
            .floating-chat-button {
                bottom: 2rem;
                right: 2rem;
                padding: 1.25rem 1.5rem;
                border-radius: 2.5rem;
            }
            
            .floating-chat-button span {
                font-size: 2rem;
            }
        }

        /* Chat Popup Modal */
        .chat-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .chat-popup {
            background: white;
            border-radius: 1.5rem;
            width: 95%;
            max-width: 500px;
            max-height: 90vh;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            position: relative;
        }

        .chat-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 1rem;
            text-align: center;
            position: relative;
        }

        .chat-header h3 {
            font-size: 1.5rem;
            margin: 0;
            font-family: 'Cinzel', serif;
        }

        .chat-header p {
            margin: 10px 0 0 0;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .chat-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        .chat-close:hover {
            opacity: 1;
        }

        .chat-body {
            padding: 1rem;
            max-height: 60vh;
            overflow-y: auto;
        }

        /* Mobile-responsive chat */
        @media (min-width: 640px) {
            .chat-popup {
                width: 90%;
                max-height: 80vh;
            }
            
            .chat-header {
                padding: 1.5rem;
            }
            
            .chat-body {
                padding: 1.5rem;
                max-height: 50vh;
            }
        }

        @media (min-width: 1024px) {
            .chat-popup {
                width: 80%;
                max-height: 75vh;
            }
            
            .chat-header {
                padding: 2rem;
            }
            
            .chat-body {
                padding: 2rem;
                max-height: 45vh;
            }
        }

        .chat-messages {
            margin-bottom: 1rem;
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            background: #f9fafb;
        }

        .chat-message {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 0.75rem;
            animation: fadeIn 0.3s ease;
            font-size: 0.875rem;
            line-height: 1.4;
        }

        .chat-message.user {
            background: #dbeafe;
            text-align: right;
            margin-left: 1rem;
        }

        .chat-message.ai {
            background: #f3f4f6;
            margin-right: 1rem;
        }

        /* Mobile-responsive chat messages */
        @media (min-width: 640px) {
            .chat-messages {
                max-height: 300px;
                padding: 1.25rem;
                border-radius: 1rem;
            }
            
            .chat-message {
                padding: 1rem;
                font-size: 1rem;
                line-height: 1.5;
                border-radius: 1rem;
            }
            
            .chat-message.user {
                margin-left: 1.5rem;
            }
            
            .chat-message.ai {
                margin-right: 1.5rem;
            }
        }

        @media (min-width: 1024px) {
            .chat-messages {
                max-height: 350px;
                padding: 1.5rem;
            }
            
            .chat-message {
                padding: 1.25rem;
                font-size: 1.125rem;
                line-height: 1.6;
            }
            
            .chat-message.user {
                margin-left: 2rem;
            }
            
            .chat-message.ai {
                margin-right: 2rem;
            }
        }

        .chat-input-section {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 1rem;
        }

        .chat-input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            outline: none;
            font-size: 0.875rem;
            transition: border-color 0.3s ease;
        }

        .chat-input:focus {
            border-color: #6366f1;
        }

        .chat-send-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            touch-action: manipulation;
            white-space: nowrap;
        }

        .chat-send-btn:hover, .chat-send-btn:active {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(99, 102, 241, 0.4);
        }

        .chat-send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Mobile-responsive chat input */
        @media (min-width: 640px) {
            .chat-input-section {
                gap: 0.75rem;
            }
            
            .chat-input {
                padding: 1rem;
                font-size: 1rem;
                border-radius: 1rem;
            }
            
            .chat-send-btn {
                padding: 1rem 1.5rem;
                font-size: 1rem;
                border-radius: 1rem;
            }
            
            .chat-send-btn:hover {
                transform: translateY(-2px);
            }
        }

        @media (min-width: 1024px) {
            .chat-input-section {
                gap: 1rem;
            }
            
            .chat-input {
                padding: 1.25rem;
                font-size: 1.125rem;
            }
            
            .chat-send-btn {
                padding: 1.25rem 2rem;
                font-size: 1.125rem;
            }
        }

        .chat-controls {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            align-items: center;
            margin-bottom: 1rem;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 0.75rem;
            flex-wrap: wrap;
        }

        .language-selector {
            padding: 0.5rem 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
            font-size: 0.875rem;
        }

        .language-selector:focus {
            border-color: #6366f1;
            outline: none;
        }

        .voice-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 0.5rem;
            border-radius: 50%;
            cursor: pointer;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            touch-action: manipulation;
        }

        .voice-btn:hover, .voice-btn:active {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }

        .voice-btn.recording {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            animation: pulse 1s infinite;
        }

        /* Mobile-responsive chat controls */
        @media (min-width: 640px) {
            .chat-controls {
                gap: 0.75rem;
                padding: 1.25rem;
                border-radius: 1rem;
            }
            
            .language-selector {
                padding: 0.75rem 1rem;
                font-size: 1rem;
                border-radius: 0.75rem;
            }
            
            .voice-btn {
                width: 3rem;
                height: 3rem;
                padding: 0.75rem;
            }
            
            .voice-btn:hover {
                transform: scale(1.1);
            }
        }

        @media (min-width: 1024px) {
            .chat-controls {
                gap: 1rem;
                padding: 1.5rem;
            }
            
            .language-selector {
                padding: 1rem 1.25rem;
                font-size: 1.125rem;
            }
            
            .voice-btn {
                width: 3.5rem;
                height: 3.5rem;
                padding: 1rem;
            }
        }

        .chat-loading {
            text-align: center;
            padding: 1rem;
            color: #6366f1;
            font-size: 0.875rem;
        }

        .chat-loading::after {
            content: "...";
            animation: dots 1.5s infinite;
        }

        /* Mobile-responsive chat loading */
        @media (min-width: 640px) {
            .chat-loading {
                padding: 1.25rem;
                font-size: 1rem;
            }
        }

        @media (min-width: 1024px) {
            .chat-loading {
                padding: 1.5rem;
                font-size: 1.125rem;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes dots {
            0%, 20% { content: "."; }
            40% { content: ".."; }
            60%, 100% { content: "..."; }
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes magicalPulse {
            0% { 
                transform: scale(1) rotateY(0deg);
                text-shadow: 0 0 30px rgba(139, 92, 246, 0.3);
            }
            33% { 
                transform: scale(1.02) rotateY(2deg);
                text-shadow: 0 0 40px rgba(59, 130, 246, 0.4);
            }
            66% { 
                transform: scale(1.01) rotateY(-1deg);
                text-shadow: 0 0 35px rgba(16, 185, 129, 0.35);
            }
            100% { 
                transform: scale(1) rotateY(0deg);
                text-shadow: 0 0 30px rgba(139, 92, 246, 0.3);
            }
        }
        
        .magical-sparkle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: radial-gradient(circle, #ffffff, #f59e0b);
            border-radius: 50%;
            animation: sparkle 2s ease-in-out infinite;
        }
        
        @keyframes sparkle {
            0%, 100% { 
                opacity: 0;
                transform: scale(0.5) rotate(0deg);
            }
            50% { 
                opacity: 1;
                transform: scale(1.2) rotate(180deg);
            }
        }
        
        .magical-orb {
            position: absolute;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.8), rgba(139, 92, 246, 0.2));
            border-radius: 50%;
            animation: orbFloat 4s ease-in-out infinite;
        }
        
        @keyframes orbFloat {
            0%, 100% { 
                transform: translateY(0) scale(1);
                opacity: 0.7;
            }
            50% { 
                transform: translateY(-20px) scale(1.3);
                opacity: 1;
            }
        }
        
        @keyframes soulFloat {
            0%, 100% { 
                transform: translateY(0) scale(1) rotate(0deg);
                opacity: 0.8;
            }
            50% { 
                transform: translateY(-15px) scale(1.2) rotate(180deg);
                opacity: 1;
            }
        }
        
        @keyframes sacredRotate {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        @keyframes cosmicSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes textGlow {
            0%, 100% { 
                text-shadow: 0 2px 8px rgba(0,0,0,0.3);
                transform: scale(1);
            }
            50% { 
                text-shadow: 0 0 20px rgba(255,215,0,0.6), 0 2px 8px rgba(0,0,0,0.3);
                transform: scale(1.02);
            }
        }
        
        @keyframes energyFlow {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        @keyframes soulPulse {
            0%, 100% { 
                transform: scale(1);
                opacity: 0.8;
            }
            50% { 
                transform: scale(1.3);
                opacity: 1;
            }
        }
        
        @keyframes twinkle {
            0%, 100% { 
                opacity: 0.7;
                transform: scale(1) rotate(0deg);
            }
            50% { 
                opacity: 1;
                transform: scale(1.2) rotate(180deg);
            }
        }

        /* Soul Contract Ceremony Portal Styles */
        .ceremony-portal-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #000428, #004e92);
            z-index: 10000;
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }
        
        .ceremony-portal-container.active {
            opacity: 1;
        }
        
        .ceremony-portal-content {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .cosmic-elements-orbit {
            position: absolute;
            width: 400px;
            height: 400px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.2);
            animation: rotate 20s linear infinite;
        }
        
        .cosmic-element {
            position: absolute;
            font-size: 2rem;
            opacity: 0.8;
            animation: float 3s ease-in-out infinite;
        }
        
        .sacred-parchment {
            position: absolute;
            width: 80%;
            max-width: 600px;
            background: rgba(255, 248, 220, 0.95);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            color: #8b4513;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.5s ease;
        }
        
        .sacred-parchment.visible {
            opacity: 1;
            transform: scale(1);
        }
        
        .signature-ceremony {
            position: absolute;
            width: 80%;
            max-width: 500px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            opacity: 0;
            transform: translateY(50px);
            transition: all 0.5s ease;
        }
        
        .signature-ceremony.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        .signature-canvas {
            width: 100%;
            height: 200px;
            border: 2px solid #f59e0b;
            border-radius: 10px;
            cursor: crosshair;
            background: #fefce8;
        }
        
        .maya-glyphs {
            display: flex;
            justify-content: space-around;
            margin-top: 1rem;
        }
        
        .glyph {
            font-size: 2rem;
            color: #f59e0b;
            opacity: 0.5;
            transition: all 0.3s ease;
        }
        
        .glyph.illuminated {
            opacity: 1;
            text-shadow: 0 0 20px #f59e0b;
            transform: scale(1.2);
        }
        
        .shaman-guide {
            position: absolute;
            top: 10%;
            right: 5%;
            width: 200px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 1rem;
            text-align: center;
            opacity: 0;
            transform: translateX(50px);
            transition: all 0.5s ease;
        }
        
        .shaman-guide.visible {
            opacity: 1;
            transform: translateX(0);
        }
        
        .shaman-avatar {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }
        
        .cosmic-seal {
            position: absolute;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, #ffd700, #ff6b6b);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: scale(0);
            transition: all 0.5s ease;
        }
        
        .cosmic-seal.visible {
            opacity: 1;
            transform: scale(1);
        }
        
        .seal-symbol {
            font-size: 4rem;
            color: white;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }
        
        .seal-text {
            color: white;
            font-weight: bold;
            text-align: center;
            margin-top: 0.5rem;
        }
        
        .ceremony-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 1rem;
        }
        
        .ceremony-button {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }
        
        .ceremony-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
        }
        
        .ceremony-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .ceremony-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        @media (max-width: 768px) {
            .cosmic-elements-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 20px;
            }
            
            .sacred-parchment,
            .signature-ceremony {
                width: 95%;
                padding: 1.5rem;
            }
            
            .shaman-guide {
                width: 180px;
                right: 2%;
            }
            
            .cosmic-seal {
                width: 250px;
                height: 250px;
            }
            
            .ceremony-controls {
                bottom: 10px;
            }
        }

        /* Phase 1 Utility Classes (SAFE - New classes only, no existing modifications) */
        .bubble-card-standard {
            background: var(--white-transparent);
            border-radius: var(--border-radius-standard);
            padding: 1.5rem;
            box-shadow: var(--shadow-standard);
            transition: var(--transition-standard);
            border: 2px solid var(--border-color);
        }

        .button-standard {
            background: var(--primary-gradient);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius-pill);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-standard);
        }

        .button-standard:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-standard);
        }

        .button-secondary {
            background: var(--secondary-gradient);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius-pill);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-standard);
        }

        .button-accent {
            background: var(--accent-gradient);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius-pill);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-standard);
        }

        .button-success {
            background: var(--success-gradient);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius-pill);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-standard);
        }

        /* Typography Utility Classes (SAFE - New classes only) */
        .heading-primary {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .heading-secondary {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            color: var(--text-primary);
            margin-bottom: 0.8rem;
        }

        .heading-tertiary {
            font-family: 'Playfair Display', serif;
            font-size: 1.4rem;
            color: var(--text-secondary);
            margin-bottom: 0.6rem;
        }

        .body-text {
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .small-text {
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Layout Utility Classes (SAFE - New classes only) */
        .container-standard {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }

        .grid-2-col {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        .grid-3-col {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }

        .grid-4-col {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
        }

        .grid-auto-fit {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        /* Responsive Grid Utilities (SAFE - New classes only) */
        @media (max-width: 768px) {
            .grid-2-col,
            .grid-3-col,
            .grid-4-col {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 1024px) {
            .grid-4-col {
                grid-template-columns: repeat(2, 1fr);
            }
            .grid-3-col {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Enhanced Cosmic Particles Background -->
    <div id="cosmic-particles-dashboard" class="cosmic-particles-container"></div>
    <!-- Floating cosmic elements background -->
    <div class="floating-elements">
        <div class="floating-element" style="left: 10%; animation-delay: 0s;">🌟</div>
        <div class="floating-element" style="left: 20%; animation-delay: 2s;">🌙</div>
        <div class="floating-element" style="left: 30%; animation-delay: 4s;">✨</div>
        <div class="floating-element" style="left: 40%; animation-delay: 6s;">🔮</div>
        <div class="floating-element" style="left: 50%; animation-delay: 8s;">🌟</div>
        <div class="floating-element" style="left: 60%; animation-delay: 10s;">🌙</div>
        <div class="floating-element" style="left: 70%; animation-delay: 12s;">✨</div>
        <div class="floating-element" style="left: 80%; animation-delay: 14s;">🔮</div>
        <div class="floating-element" style="left: 90%; animation-delay: 16s;">🌟</div>
    </div>

    <!-- Soul Contract Ceremony Portal -->
    <div id="ceremony-portal" class="ceremony-portal-container" style="display: none;">
        <div class="ceremony-portal-content">
            <!-- Cosmic Elements Orbit -->
            <div id="cosmic-elements-orbit" class="cosmic-elements-orbit">
                <div class="cosmic-element" data-element="fire">🔥</div>
                <div class="cosmic-element" data-element="water">💧</div>
                <div class="cosmic-element" data-element="earth">🌍</div>
                <div class="cosmic-element" data-element="air">💨</div>
                <div class="cosmic-element" data-element="spirit">✨</div>
                <div class="cosmic-element" data-element="light">🌟</div>
            </div>
            
            <!-- Sacred Parchment -->
            <div id="sacred-parchment" class="sacred-parchment">
                <div class="parchment-content">
                    <h2 class="parchment-title">Sacred Soul Contract</h2>
                    <div class="parchment-body">
                        <p>Loading your sacred soul contract...</p>
                    </div>
                </div>
            </div>
            
            <!-- Signature Ceremony -->
            <div id="signature-ceremony" class="signature-ceremony">
                <div class="signature-content">
                    <h3>Sign Your Sacred Contract</h3>
                    <canvas id="sacred-signature-canvas" class="signature-canvas"></canvas>
                    <div class="maya-glyphs">
                        <div class="glyph">𝕊</div>
                        <div class="glyph">𝕀</div>
                        <div class="glyph">𝔾</div>
                        <div class="glyph">ℕ</div>
                    </div>
                </div>
            </div>
            
            <!-- Shaman Guide -->
            <div id="shaman-guide" class="shaman-guide">
                <div class="shaman-avatar">🧙‍♀️</div>
                <div class="shaman-message">
                    <div class="shaman-blessing-text">
                        <p>Sacred soul, I witness your commitment to your cosmic journey.</p>
                    </div>
                </div>
            </div>
            
            <!-- Cosmic Seal -->
            <div id="cosmic-seal" class="cosmic-seal">
                <div class="seal-content">
                    <div class="seal-symbol">⭐</div>
                    <div class="seal-text">Your soul contract is sealed</div>
                </div>
            </div>
            
            <!-- Ceremony Controls -->
            <div class="ceremony-controls">
                <button id="ceremony-continue" class="ceremony-button">View Soul Contract</button>
                <button id="ceremony-close" class="ceremony-close-btn" onclick="window.activeCeremonyPortal?.closeCeremony()">×</button>
            </div>
        </div>
    </div>



    <div class="dashboard-container">

        

        
        <!-- Enhanced Soul Introduction Header -->
        <div class="header">
            <button class="logout-button" onclick="logout()">Logout</button>
            
            <!-- Navigation -->
            <div class="header-nav">
                <a href="#" class="nav-link" onclick="showComingSoon('Shop')">🛍️ Shop</a>
                <a href="#" class="nav-link" onclick="showComingSoon('Events')">🌺 Events</a>
                <a href="https://MayanBelize.com" target="_blank" class="nav-link">🌎 MayanBelize.com</a>
            </div>
            
            <div class="cosmic-title-section">
                <!-- Interactive Magical Title with 3D Particle System -->
                <div id="magicalTitle" style="position: relative; margin-bottom: 10px; overflow: hidden; perspective: 1000px;">
                    <canvas id="particleCanvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;"></canvas>
                    <h1 id="magicalTitleText" style="position: relative; z-index: 2; font-size: 3.5rem; margin: 0; background: linear-gradient(135deg, #8b5cf6, #3b82f6, #10b981); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-shadow: 0 0 30px rgba(139, 92, 246, 0.3); cursor: pointer; transition: all 0.3s ease; animation: magicalPulse 3s ease-in-out infinite;">🌟 The Magic is You</h1>
                </div>
                <div class="soul-title" style="font-size: 1.0rem; color: #6366f1; font-weight: 600; margin-bottom: 20px;">
                    Welcome back, <span style="font-size: 1.0rem;">🔥</span> <span id="userName" style="background: linear-gradient(135deg, #f59e0b, #d97706); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: 700;"></span>.
                </div>
                
                <!-- Enhanced Welcome Information -->
                <div class="enhanced-welcome-info" style="display: flex; justify-content: center; gap: 30px; margin-bottom: 15px; flex-wrap: wrap;">
                    <div style="font-size: 0.9rem; color: #5830a3; font-weight: 500;">
                        <span style="font-weight: 700;">Birth Time:</span> <span id="welcomeBirthTime">Loading...</span>
                    </div>
                    <div style="font-size: 0.9rem; color: #5830a3; font-weight: 500;">
                        <span style="font-weight: 700;">Birth Location:</span> <span id="welcomeBirthLocation">Loading...</span>
                    </div>
                </div>
            </div>
            
            <!-- Magical Soul Introduction with Enhanced Graphics -->
            <div class="magical-soul-intro" style="
                position: relative;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 35%, #9b59b6 65%, #e74c3c 100%);
                border-radius: 25px;
                padding: 40px;
                margin: 25px 0;
                color: white;
                text-align: center;
                box-shadow: 0 25px 60px rgba(0,0,0,0.2);
                overflow: hidden;
                perspective: 1000px;
            ">
                <!-- Animated Background Elements -->
                <div class="soul-bg-particles" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;">
                    <div class="soul-particle" style="position: absolute; width: 6px; height: 6px; background: radial-gradient(circle, #ffd700, #ff6b6b); border-radius: 50%; top: 20%; left: 15%; animation: soulFloat 4s ease-in-out infinite;"></div>
                    <div class="soul-particle" style="position: absolute; width: 4px; height: 4px; background: radial-gradient(circle, #00f5ff, #8a2be2); border-radius: 50%; top: 70%; right: 20%; animation: soulFloat 3s ease-in-out infinite 1s;"></div>
                    <div class="soul-particle" style="position: absolute; width: 8px; height: 8px; background: radial-gradient(circle, #ff69b4, #ffd700); border-radius: 50%; top: 45%; left: 5%; animation: soulFloat 5s ease-in-out infinite 2s;"></div>
                    <div class="soul-particle" style="position: absolute; width: 5px; height: 5px; background: radial-gradient(circle, #00ff7f, #ff1493); border-radius: 50%; top: 15%; right: 10%; animation: soulFloat 3.5s ease-in-out infinite 0.5s;"></div>
                    <div class="soul-particle" style="position: absolute; width: 7px; height: 7px; background: radial-gradient(circle, #9370db, #ffd700); border-radius: 50%; top: 80%; left: 80%; animation: soulFloat 4.5s ease-in-out infinite 1.5s;"></div>
                </div>
                
                <!-- Sacred Geometry Background -->
                <div class="sacred-geometry" style="
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    width: 200px;
                    height: 200px;
                    opacity: 0.1;
                    z-index: 1;
                    animation: sacredRotate 20s linear infinite;
                ">
                    <svg width="200" height="200" viewBox="0 0 200 200" style="filter: drop-shadow(0 0 20px rgba(255,215,0,0.3));">
                        <circle cx="100" cy="100" r="80" fill="none" stroke="#ffd700" stroke-width="2"/>
                        <circle cx="100" cy="100" r="60" fill="none" stroke="#fff" stroke-width="1"/>
                        <circle cx="100" cy="100" r="40" fill="none" stroke="#ff69b4" stroke-width="1"/>
                        <polygon points="100,40 140,80 140,120 100,160 60,120 60,80" fill="none" stroke="#00f5ff" stroke-width="1"/>
                        <polygon points="100,20 160,100 100,180 40,100" fill="none" stroke="#8a2be2" stroke-width="1"/>
                    </svg>
                </div>
                
                <!-- Main Soul Content -->
                <div id="soulEssenceContent" style="
                    position: relative;
                    z-index: 2;
                    font-size: 1.1rem;
                    line-height: 1.8;
                    opacity: 0.95;
                    text-shadow: 0 2px 8px rgba(0,0,0,0.3);
                ">
                    <div class="magical-loading" style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
                        <div class="cosmic-spinner" style="
                            width: 60px;
                            height: 60px;
                            border: 3px solid rgba(255,255,255,0.3);
                            border-top: 3px solid #ffd700;
                            border-radius: 50%;
                            animation: cosmicSpin 2s linear infinite;
                            filter: drop-shadow(0 0 15px rgba(255,215,0,0.5));
                        "></div>
                        <p style="font-size: 1.2rem; font-weight: 600; animation: textGlow 3s ease-in-out infinite;">Channeling your cosmic soul essence...</p>
                        <div class="soul-energy-bar" style="
                            width: 200px;
                            height: 8px;
                            background: rgba(255,255,255,0.2);
                            border-radius: 4px;
                            overflow: hidden;
                            position: relative;
                        ">
                            <div class="energy-fill" style="
                                width: 100%;
                                height: 100%;
                                background: linear-gradient(90deg, #ffd700, #ff69b4, #00f5ff, #8a2be2);
                                border-radius: 4px;
                                animation: energyFlow 2s ease-in-out infinite;
                            "></div>
                        </div>
                    </div>
                </div>
                
                <!-- Personalized Snapshot Section -->
                <div style="margin-top: 30px; position: relative; z-index: 2;">
                    <div id="personalizedSnapshotContent" class="magical-snapshot" style="
                        background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.05) 100%);
                        border: 2px solid rgba(255,255,255,0.3);
                        border-radius: 20px;
                        padding: 25px;
                        backdrop-filter: blur(10px);
                        box-shadow: inset 0 0 30px rgba(255,255,255,0.1);
                        font-size: 1.1rem;
                        line-height: 1.8;
                        opacity: 0.95;
                        text-shadow: 0 2px 8px rgba(0,0,0,0.3);
                    ">
                        <div class="magical-loading" style="display: flex; flex-direction: column; align-items: center; gap: 15px;">
                            <div class="pulse-circle" style="
                                width: 40px;
                                height: 40px;
                                background: radial-gradient(circle, #ffd700, #ff69b4);
                                border-radius: 50%;
                                animation: soulPulse 2s ease-in-out infinite;
                                filter: drop-shadow(0 0 20px rgba(255,215,0,0.6));
                            "></div>
                            <p style="font-size: 1.1rem; font-weight: 500; animation: textGlow 3s ease-in-out infinite 1s;">Revealing your personalized cosmic blueprint...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Mystical Corner Elements -->
                <div class="mystical-corners">
                    <div style="position: absolute; top: 15px; left: 15px; font-size: 1.5rem; opacity: 0.7; animation: twinkle 3s ease-in-out infinite;">✨</div>
                    <div style="position: absolute; top: 15px; right: 15px; font-size: 1.5rem; opacity: 0.7; animation: twinkle 3s ease-in-out infinite 1s;">🌟</div>
                    <div style="position: absolute; bottom: 15px; left: 15px; font-size: 1.5rem; opacity: 0.7; animation: twinkle 3s ease-in-out infinite 2s;">🔮</div>
                    <div style="position: absolute; bottom: 15px; right: 15px; font-size: 1.5rem; opacity: 0.7; animation: twinkle 3s ease-in-out infinite 0.5s;">💫</div>
                </div>
            </div>
            

        </div>

        <!-- Main Features Section -->
        <div class="cosmic-elements-section">
            <h2>🌟 Your Sacred Cosmic Analysis</h2>
            <div class="main-features-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; max-width: 1200px; margin: 0 auto; padding: 0 20px;">
                <style>
                    @media (max-width: 768px) {
                        .main-features-grid {
                            grid-template-columns: 1fr !important;
                        }
                    }
                </style>
                <!-- Cosmic Blueprint Feature -->
                <div class="main-feature-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 1rem; padding: 1.5rem; color: white; text-align: center; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 10px 30px rgba(0,0,0,0.1);" onclick="showCosmicBlueprint()">
                    <div style="font-size: 3rem; margin-bottom: 15px;">🌌</div>
                    <h3 style="font-size: 1.8rem; margin-bottom: 15px; color: white;">Your Cosmic Blueprint</h3>
                    <p style="font-size: 1.1rem; line-height: 1.6; opacity: 0.9; margin-bottom: 25px;">Complete analysis of your 35+ cosmic elements revealing your spiritual DNA and cosmic purpose</p>
                    <button style="background: rgba(255,255,255,0.2); border: 2px solid white; color: white; padding: 12px 25px; border-radius: 25px; font-weight: 600; cursor: pointer;">View Full Blueprint</button>
                </div>

                <!-- Soul Contract Feature -->
                <div class="main-feature-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 1rem; padding: 1.5rem; color: white; text-align: center; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 10px 30px rgba(0,0,0,0.1);" onclick="generateDetailedSoulContract()">
                    <div style="font-size: 3rem; margin-bottom: 15px;">🌟</div>
                    <h3 style="font-size: 1.8rem; margin-bottom: 15px; color: white;">Sacred Soul Contract</h3>
                    <p style="font-size: 1.1rem; line-height: 1.6; opacity: 0.9; margin-bottom: 25px;">Discover your personalized soul contract with Soul Origins, Sacred Gifts, Growth Challenges, and Destiny Mission</p>
                    <button style="background: rgba(255,255,255,0.2); border: 2px solid white; color: white; padding: 12px 25px; border-radius: 25px; font-weight: 600; cursor: pointer;">View Soul Contract</button>
                </div>

                <!-- Daily Insights Feature -->
                <div class="main-feature-card" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); border-radius: 1rem; padding: 1.5rem; color: white; text-align: center; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 10px 30px rgba(0,0,0,0.1);" onclick="showDailyInsights()">
                    <div style="font-size: 3rem; margin-bottom: 15px;">🌅</div>
                    <h3 style="font-size: 1.8rem; margin-bottom: 15px; color: white;">Daily Spiritual Insights</h3>
                    <p style="font-size: 1.1rem; line-height: 1.6; opacity: 0.9; margin-bottom: 25px;">Personalized daily guidance based on cosmic energy and your spiritual blueprint</p>
                    <button style="background: rgba(255,255,255,0.2); border: 2px solid white; color: white; padding: 12px 25px; border-radius: 25px; font-weight: 600; cursor: pointer;">View Daily Insights</button>
                </div>

                <!-- Spiritual Guidance Feature -->
                <div class="main-feature-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); border-radius: 1rem; padding: 1.5rem; color: white; text-align: center; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 10px 30px rgba(0,0,0,0.1);" onclick="showGuidanceRequest()">
                    <div style="font-size: 3rem; margin-bottom: 15px;">🔮</div>
                    <h3 style="font-size: 1.8rem; margin-bottom: 15px; color: white;">Request Spiritual Guidance</h3>
                    <p style="font-size: 1.1rem; line-height: 1.6; opacity: 0.9; margin-bottom: 25px;">Get personalized spiritual guidance for your current situation and challenges</p>
                    <button style="background: rgba(255,255,255,0.2); border: 2px solid white; color: white; padding: 12px 25px; border-radius: 25px; font-weight: 600; cursor: pointer;">Request Guidance</button>
                </div>
            </div>
        </div>





        <!-- Cosmic Elements Section -->
        <div class="cosmic-elements-section">
            <h2>🔮 Your Complete Cosmic Elements</h2>
            <p style="text-align: center; font-size: 1.1rem; color: #8b5cf6; font-weight: 500; margin-bottom: 30px;">Explore all 35+ elements that make up your unique spiritual blueprint</p>
            
            <div class="cosmic-elements-grid">
            <!-- Core Maya Signature -->
            <div class="element-category">
                <h3 class="category-title">🔮 Core Maya Elements</h3>
                <div class="category-grid">
                    <div class="element-bubble" onclick="showElementDetails('day_sign', 'Day Sign')">
                        <div class="element-icon">😌</div>
                        <div class="element-name">Day Sign</div>
                        <div class="element-value" id="daySign">Loading...</div>
                    </div>
                    <div class="element-bubble" onclick="showElementDetails('galactic_tone', 'Galactic Tone')">
                        <div class="element-icon">🎵</div>
                        <div class="element-name">Galactic Tone</div>
                        <div class="element-value" id="galacticTone">Loading...</div>
                    </div>
                    <div class="element-bubble" onclick="showElementDetails('kin_number', 'Kin Number')">
                        <div class="element-icon">🔢</div>
                        <div class="element-name">Kin Number</div>
                        <div class="element-value" id="kinNumber">Loading...</div>
                    </div>
                    <div class="element-bubble" onclick="showElementDetails('element', 'Element')">
                        <div class="element-icon">⚡</div>
                        <div class="element-name">Element</div>
                        <div class="element-value" id="element">Loading...</div>
                    </div>
                    <div class="element-bubble" onclick="showElementDetails('direction', 'Life Path')">
                        <div class="element-icon">🗺️</div>
                        <div class="element-name">Life Path</div>
                        <div class="element-value" id="direction">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Sacred Calendar Cycles -->
            <div class="element-category">
                <h3 class="category-title">📅 Sacred Calendar Elements</h3>
                <div class="category-grid">
                    <div class="element-bubble" onclick="showElementDetails('trecena', 'Trecena')">
                        <div class="element-icon">⚡</div>
                        <div class="element-name">Trecena</div>
                        <div class="element-value" id="trecena">Loading...</div>
                    </div>
                    <div class="element-bubble" onclick="showElementDetails('wavespell', 'Wavespell')">
                        <div class="element-icon">🌊</div>
                        <div class="element-name">Wavespell</div>
                        <div class="element-value" id="wavespell">Loading...</div>
                    </div>
                    <div class="element-bubble" onclick="showElementDetails('castle', 'Castle')">
                        <div class="element-icon">🏰</div>
                        <div class="element-name">Castle</div>
                        <div class="element-value" id="castle">Loading...</div>
                    </div>
                    <div class="element-bubble" onclick="showElementDetails('color_family', 'Color Family')">
                        <div class="element-icon">🌸</div>
                        <div class="element-name">Color Family</div>
                        <div class="element-value" id="colorFamily">Loading...</div>
                    </div>
                    <div class="element-bubble" onclick="showElementDetails('tribe', 'Tribe')">
                        <div class="element-icon">🏺</div>
                        <div class="element-name">Tribe</div>
                        <div class="element-value" id="tribe">Loading...</div>
                    </div>
                    <div class="element-bubble" onclick="showElementDetails('harmonic', 'Harmonic')">
                        <div class="element-icon">🔮</div>
                        <div class="element-name">Harmonic</div>
                        <div class="element-value" id="harmonic">Loading...</div>
                    </div>
                    <div class="element-bubble" onclick="showElementDetails('galactic_activation_portal', 'Activation Portal')">
                        <div class="element-icon">☀️</div>
                        <div class="element-name">Activation Portal</div>
                        <div class="element-value" id="galacticActivationPortal">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Maya Cross & Extended Calendar -->
            <div class="element-category">
                <h3 class="category-title">✨ Maya Cross & Calendar Systems</h3>
                <div class="category-grid">
                    <div class="element-bubble" onclick="showElementDetails('guide_sign', 'Guide Sign')">
                        <div class="element-icon">🧭</div>
                        <div class="element-name">Guide Sign</div>
                        <div class="element-value" id="guideSign">Loading...</div>
                    </div>
                    <div class="element-bubble" onclick="showElementDetails('antipode_sign', 'Antipode Sign')">
                        <div class="element-icon">⚖️</div>
                        <div class="element-name">Antipode Sign</div>
                        <div class="element-value" id="antipodeSign">Loading...</div>
                    </div>
                    <div class="element-bubble" onclick="showElementDetails('occult_sign', 'Occult Sign')">
                        <div class="element-icon">🔮</div>
                        <div class="element-name">Occult Sign</div>
                        <div class="element-value" id="occultSign">Loading...</div>
                    </div>
                    <div class="element-bubble" onclick="showElementDetails('lord_of_night', 'Lord of Night')">
                        <div class="element-icon">🌙</div>
                        <div class="element-name">Lord of Night</div>
                        <div class="element-value" id="lordOfNight">Loading...</div>
                    </div>
                    <div class="element-bubble" onclick="showElementDetails('haab_date', 'Haab Date')">
                        <div class="element-icon">☀️</div>
                        <div class="element-name">Haab Date</div>
                        <div class="element-value" id="haabDate">Loading...</div>
                    </div>
                    <div class="element-bubble" onclick="showElementDetails('long_count', 'Long Count')">
                        <div class="element-icon">📊</div>
                        <div class="element-name">Long Count</div>
                        <div class="element-value" id="longCount">Loading...</div>
                    </div>
                    <div class="element-bubble" onclick="showElementDetails('year_bearer', 'Year Bearer')">
                        <div class="element-icon">🗓️</div>
                        <div class="element-name">Year Bearer</div>
                        <div class="element-value" id="yearBearer">Loading...</div>
                    </div>
                    <div class="element-bubble" onclick="showElementDetails('moon_phase', 'Moon Phase')">
                        <div class="element-icon">🌙</div>
                        <div class="element-name">Moon Phase</div>
                        <div class="element-value" id="moonPhase">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Spiritual & Natural Elements -->
            <div class="element-category">
                <h3 class="category-title">🌿 Spiritual & Natural Elements</h3>
                <div class="category-grid">
                    <div class="element-bubble" onclick="showElementDetails('spirit_animal', 'Spirit Animal')">
                        <div class="element-icon">🦅</div>
                        <div class="element-name">Spirit Animal</div>
                        <div class="element-value" id="spiritAnimal">Loading...</div>
                    </div>
                    <div class="element-bubble" onclick="showElementDetails('crystal_ally', 'Crystal Ally')">
                        <div class="element-icon">💎</div>
                        <div class="element-name">Crystal Ally</div>
                        <div class="element-value" id="crystalAlly">Loading...</div>
                    </div>
                    <div class="element-bubble" onclick="showElementDetails('plant_medicine', 'Plant Medicine')">
                        <div class="element-icon">🌿</div>
                        <div class="element-name">Plant Medicine</div>
                        <div class="element-value" id="plantMedicine">Loading...</div>
                    </div>
                    <div class="element-bubble" onclick="showElementDetails('chakra_resonance', 'Chakra Resonance')">
                        <div class="element-icon">🧘</div>
                        <div class="element-name">Chakra Resonance</div>
                        <div class="element-value" id="chakraResonance">Loading...</div>
                    </div>
                    <div class="element-bubble" onclick="showElementDetails('human_design_type', 'Human Design Type')">
                        <div class="element-icon">🏛️</div>
                        <div class="element-name">Human Design Type</div>
                        <div class="element-value" id="humanDesignType">Loading...</div>
                    </div>
                    <div class="element-bubble" onclick="showElementDetails('tree_of_life_primary', 'Tree of Life Primary')">
                        <div class="element-icon">🌳</div>
                        <div class="element-name">Tree of Life Primary</div>
                        <div class="element-value" id="treeOfLifePrimary">Loading...</div>
                    </div>
                    <div class="element-bubble" onclick="showElementDetails('tree_of_life_secondary', 'Tree of Life Secondary')">
                        <div class="element-icon">🌲</div>
                        <div class="element-name">Tree of Life Secondary</div>
                        <div class="element-value" id="treeOfLifeSecondary">Loading...</div>
                    </div>
                </div>
            </div>

        </div>
        </div>

        <!-- Floating Chat Button - Ix Chel AI -->
        <button class="floating-chat-button" onclick="openFloatingChat()" title="Chat with Maya Shaman">
            <span style="font-size: 0.9rem; font-weight: 600;">Chat with Maya Shaman</span>
        </button>

        <!-- Chat Popup Modal -->
        <div id="chatPopupOverlay" class="chat-popup-overlay" onclick="closeFloatingChat()">
            <div class="chat-popup" onclick="event.stopPropagation()">
                <div class="chat-header">
                    <button class="chat-close" onclick="closeFloatingChat()">×</button>
                    <h3>🌙 Chat with Ix Chel</h3>
                    <p>Ancient Maya goddess of wisdom, healing, and guidance</p>
                </div>
                
                <div class="chat-body">
                    <div class="chat-controls">
                        <select id="chatLanguage" class="language-selector">
                            <option value="english">English</option>
                            <option value="spanish">Español</option>
                        </select>
                        <button id="voiceBtn" class="voice-btn" onclick="toggleVoiceInput()">🎤</button>
                    </div>
                    
                    <div id="chatMessages" class="chat-messages">
                        <div class="chat-message ai">
                            <strong>Ix Chel:</strong> In Lak'ech, sacred soul! I am Ix Chel, ancient keeper of cosmic wisdom. How may I guide you on your spiritual journey today?
                        </div>
                    </div>
                    
                    <div class="chat-input-section">
                        <input type="text" id="chatInput" class="chat-input" placeholder="Ask me about your cosmic journey..." onkeypress="handleChatKeyPress(event)">
                        <button id="chatSendBtn" class="chat-send-btn" onclick="sendChatMessage()">Send</button>
                    </div>
                </div>
            </div>
        </div>




    </div>

    <!-- Sacred Spiritual Tools - Coming Soon in Development -->
    <div class="cosmic-elements-section">
        <h2>🌟 Sacred Spiritual Tools</h2>
        <p style="font-size: 1.1rem; color: #8b4513; margin-bottom: 25px; font-style: italic; text-align: center;">
            Coming Soon in Development
        </p>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
            <div class="spiritual-tool-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 1.5rem; border-radius: 1rem; text-align: center; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); cursor: default; transition: all 0.3s ease; opacity: 0.7;">
                <div style="font-size: 2.5rem; margin-bottom: 10px;">🔮</div>
                <h3 style="font-size: 1.2rem; margin-bottom: 8px; font-weight: 600;">Maya Oracle Cards</h3>
                <p style="font-size: 0.9rem; opacity: 0.9;">20 sacred cards with AI-powered ancestral wisdom</p>
                <div style="background: rgba(255, 255, 255, 0.3); padding: 5px 10px; border-radius: 1rem; margin-top: 10px; font-size: 0.8rem; font-weight: 600; color: #8b4513;">
                    Coming Soon
                </div>
            </div>
            
            <div class="spiritual-tool-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 1.5rem; border-radius: 1rem; text-align: center; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); cursor: default; transition: all 0.3s ease; opacity: 0.7;">
                <div style="font-size: 2.5rem; margin-bottom: 10px;">🌙</div>
                <h3 style="font-size: 1.2rem; margin-bottom: 8px; font-weight: 600;">Dream Interpreter</h3>
                <p style="font-size: 0.9rem; opacity: 0.9;">AI-powered dream analysis with Maya symbolism</p>
                <div style="background: rgba(255, 255, 255, 0.3); padding: 5px 10px; border-radius: 1rem; margin-top: 10px; font-size: 0.8rem; font-weight: 600; color: #8b4513;">
                    Coming Soon
                </div>
            </div>
            
            <div class="spiritual-tool-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 1.5rem; border-radius: 1rem; text-align: center; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); cursor: default; transition: all 0.3s ease; opacity: 0.7;">
                <div style="font-size: 2.5rem; margin-bottom: 10px;">🌿</div>
                <h3 style="font-size: 1.2rem; margin-bottom: 8px; font-weight: 600;">Sacred Rituals</h3>
                <p style="font-size: 0.9rem; opacity: 0.9;">Breathwork, ceremonies & cosmic-aligned practices</p>
                <div style="background: rgba(255, 255, 255, 0.3); padding: 5px 10px; border-radius: 1rem; margin-top: 10px; font-size: 0.8rem; font-weight: 600; color: #8b4513;">
                    Coming Soon
                </div>
            </div>
        </div>
        

    </div>

    <!-- Modal for element details -->
    <div id="elementModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 class="modal-title" id="modalTitle">Element Details</h2>
            <div class="modal-body" id="modalBody">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading your personalized cosmic insights...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Include Ceremony Portal Script -->
    <script src="/static/js/ceremony-portal.js"></script>

    <script>
        let currentUser = null;
        let currentUserData = null;
        let interactionStartTime = null;

        // Global helper function to safely update element text content
        function updateElementText(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = value || 'Unknown';
            } else {
                console.warn(`Element not found: ${elementId}`);
            }
        }

        // Phase 2 Performance Optimization - Debounce function for better performance (SAFE)
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Phase 2 Performance Optimization - Optimized DOM updates (SAFE)
        const debouncedUpdateElement = debounce(updateElementText, 100);

        // Phase 2 Performance Optimization - Batch DOM updates for better performance (SAFE)
        const domUpdateQueue = [];
        let domUpdateScheduled = false;

        function batchUpdateElements(updates) {
            domUpdateQueue.push(...updates);
            if (!domUpdateScheduled) {
                domUpdateScheduled = true;
                requestAnimationFrame(() => {
                    domUpdateQueue.forEach(update => {
                        updateElementText(update.elementId, update.value);
                    });
                    domUpdateQueue.length = 0;
                    domUpdateScheduled = false;
                });
            }
        }

        // Phase 2 Performance Optimization - Optimized element caching (SAFE)
        const elementCache = new Map();
        
        function getCachedElement(elementId) {
            if (!elementCache.has(elementId)) {
                const element = document.getElementById(elementId);
                if (element) {
                    elementCache.set(elementId, element);
                }
            }
            return elementCache.get(elementId);
        }

        // Phase 2 Performance Optimization - Optimized element update with caching (SAFE)
        function updateElementTextOptimized(elementId, value) {
            const element = getCachedElement(elementId);
            if (element) {
                element.textContent = value || 'Unknown';
            } else {
                console.warn(`Element not found: ${elementId}`);
            }
        }

        // Phase 2 Performance Optimization - Lazy loading for better performance (SAFE)
        const lazyLoadObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const element = entry.target;
                    if (element.dataset.lazyLoad) {
                        const loadFunction = element.dataset.lazyLoad;
                        if (typeof window[loadFunction] === 'function') {
                            window[loadFunction](element);
                        }
                        lazyLoadObserver.unobserve(element);
                    }
                }
            });
        });

        // Phase 2 Performance Optimization - Optimized API call with caching (SAFE)
        const apiCache = new Map();
        const cacheExpiration = 5 * 60 * 1000; // 5 minutes

        function getCachedApiResponse(url) {
            const cached = apiCache.get(url);
            if (cached && Date.now() - cached.timestamp < cacheExpiration) {
                return cached.data;
            }
            return null;
        }

        function setCachedApiResponse(url, data) {
            apiCache.set(url, {
                data: data,
                timestamp: Date.now()
            });
        }

        // Phase 2 Performance Optimization - Optimized fetch with caching (SAFE)
        async function fetchWithCache(url, options = {}) {
            const cached = getCachedApiResponse(url);
            if (cached) {
                return Promise.resolve(cached);
            }

            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                setCachedApiResponse(url, data);
                return data;
            } catch (error) {
                console.error('Fetch error:', error);
                throw error;
            }
        }

        // Phase 2 Performance Optimization - Debounced scroll handler (SAFE)
        const debouncedScrollHandler = debounce(() => {
            // Handle scroll events efficiently
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const elements = document.querySelectorAll('.scroll-animate');
            
            elements.forEach(element => {
                const rect = element.getBoundingClientRect();
                if (rect.top < window.innerHeight && rect.bottom > 0) {
                    element.classList.add('in-view');
                } else {
                    element.classList.remove('in-view');
                }
            });
        }, 16); // ~60fps

        // Phase 2 Performance Optimization - Optimized event listeners (SAFE)
        function addOptimizedEventListeners() {
            // Add scroll listener with debouncing
            window.addEventListener('scroll', debouncedScrollHandler, { passive: true });
            
            // Add resize listener with debouncing
            window.addEventListener('resize', debounce(() => {
                elementCache.clear(); // Clear cache on resize
                // Recalculate any responsive elements
            }, 250));
        }

        // Phase 3 Security Enhancement - Input validation functions (SAFE - New functions only)
        // Phase 4 Code Cleanup - Enhanced documentation (SAFE - Documentation only)
        /**
         * Validate email input with comprehensive security checks.
         * 
         * @param {string} email - Email address to validate
         * @returns {boolean} True if email is valid and secure, false otherwise
         * 
         * Security Features:
         * - Length validation (max 254 characters)
         * - RFC-compliant email regex pattern
         * - Injection pattern detection
         * - XSS prevention checks
         * 
         * Dangerous Patterns Detected:
         * - HTML tags and brackets
         * - SQL injection patterns
         * - Script injection attempts
         * - Comment sequences
         */
        function validateEmailInput(email) {
            if (!email || email.length > 254) {
                return false;
            }
            
            const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            if (!emailRegex.test(email)) {
                return false;
            }
            
            // Check for dangerous patterns
            const dangerousPatterns = ['<', '>', '"', "'", ';', '--', '/*', '*/', 'script:', 'javascript:'];
            for (const pattern of dangerousPatterns) {
                if (email.toLowerCase().includes(pattern)) {
                    return false;
                }
            }
            
            return true;
        }

        function validateNameInput(name) {
            if (!name || name.length < 1 || name.length > 100) {
                return false;
            }
            
            // Check for dangerous patterns
            const dangerousPatterns = ['<', '>', '"', "'", ';', '--', '/*', '*/', 'script:', 'javascript:'];
            for (const pattern of dangerousPatterns) {
                if (name.toLowerCase().includes(pattern)) {
                    return false;
                }
            }
            
            return true;
        }

        function validatePasswordStrength(password) {
            if (!password || password.length < 8) {
                return false;
            }
            
            const hasUpper = /[A-Z]/.test(password);
            const hasLower = /[a-z]/.test(password);
            const hasDigit = /\d/.test(password);
            
            return hasUpper && hasLower && hasDigit;
        }

        // Phase 3 Security Enhancement - Secure input sanitization (SAFE - New function only)
        function sanitizeInput(input) {
            if (!input) return '';
            
            // Remove script tags
            input = input.replace(/<script[^>]*>.*?<\/script>/gi, '');
            
            // Remove HTML tags
            input = input.replace(/<[^>]+>/g, '');
            
            // Escape special characters
            input = input.replace(/&/g, '&amp;')
                          .replace(/</g, '&lt;')
                          .replace(/>/g, '&gt;')
                          .replace(/"/g, '&quot;')
                          .replace(/'/g, '&#x27;');
            
            return input.trim();
        }

        // Phase 3 Security Enhancement - Secure API request with additional headers (SAFE - New function only)
        async function secureApiRequest(url, options = {}) {
            const token = localStorage.getItem('token');
            
            // Add security headers
            const secureHeaders = {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'Cache-Control': 'no-cache',
                ...options.headers
            };
            
            if (token) {
                secureHeaders['Authorization'] = `Bearer ${token}`;
            }
            
            const secureOptions = {
                ...options,
                headers: secureHeaders,
                mode: 'cors',
                credentials: 'same-origin'
            };
            
            try {
                const response = await fetch(url, secureOptions);
                
                // Check for security headers in response
                if (response.headers.get('X-Content-Type-Options') !== 'nosniff') {
                    console.warn('Security warning: Missing X-Content-Type-Options header');
                }
                
                return response;
            } catch (error) {
                console.error('Secure API request error:', error);
                throw error;
            }
        }

        // Phase 3 Security Enhancement - Token validation (SAFE - New function only)
        function validateJWTToken(token) {
            if (!token) return false;
            
            try {
                // Basic JWT structure validation
                const parts = token.split('.');
                if (parts.length !== 3) return false;
                
                // Check if payload exists and is valid base64
                const payload = JSON.parse(atob(parts[1]));
                
                // Check expiration
                if (payload.exp && payload.exp < Date.now() / 1000) {
                    return false;
                }
                
                // Check required fields
                if (!payload.user_id) return false;
                
                return true;
            } catch (error) {
                return false;
            }
        }

        // Phase 3 Security Enhancement - Secure localStorage handling (SAFE - New functions only)
        function secureSetItem(key, value) {
            try {
                // Sanitize key and value
                const sanitizedKey = sanitizeInput(key);
                const sanitizedValue = typeof value === 'string' ? sanitizeInput(value) : JSON.stringify(value);
                
                localStorage.setItem(sanitizedKey, sanitizedValue);
                return true;
            } catch (error) {
                console.error('Error setting secure localStorage item:', error);
                return false;
            }
        }

        function secureGetItem(key) {
            try {
                const sanitizedKey = sanitizeInput(key);
                const value = localStorage.getItem(sanitizedKey);
                
                if (key === 'token' && value) {
                    // Validate token before returning
                    if (!validateJWTToken(value)) {
                        localStorage.removeItem(sanitizedKey);
                        return null;
                    }
                }
                
                return value;
            } catch (error) {
                console.error('Error getting secure localStorage item:', error);
                return null;
            }
        }

        // Phase 3 Security Enhancement - Rate limiting for client-side requests (SAFE - New function only)
        const clientRateLimiter = {
            requests: new Map(),
            
            checkLimit(endpoint, maxRequests = 10, windowMs = 60000) {
                const now = Date.now();
                const windowStart = now - windowMs;
                
                if (!this.requests.has(endpoint)) {
                    this.requests.set(endpoint, []);
                }
                
                const requests = this.requests.get(endpoint);
                
                // Remove old requests
                const validRequests = requests.filter(timestamp => timestamp > windowStart);
                this.requests.set(endpoint, validRequests);
                
                // Check if under limit
                if (validRequests.length >= maxRequests) {
                    return false;
                }
                
                // Add current request
                validRequests.push(now);
                return true;
            }
        };

        // Phase 3 Security Enhancement - Secure form validation (SAFE - New function only)
        function validateFormSecurely(formData) {
            const errors = [];
            
            // Validate each field
            for (const [key, value] of Object.entries(formData)) {
                const sanitizedValue = sanitizeInput(value);
                
                switch (key) {
                    case 'email':
                        if (!validateEmailInput(sanitizedValue)) {
                            errors.push('Invalid email format');
                        }
                        break;
                    case 'firstName':
                    case 'lastName':
                        if (!validateNameInput(sanitizedValue)) {
                            errors.push(`Invalid ${key} format`);
                        }
                        break;
                    case 'password':
                        if (!validatePasswordStrength(sanitizedValue)) {
                            errors.push('Password must be at least 8 characters with uppercase, lowercase, and numbers');
                        }
                        break;
                }
                
                // Update form data with sanitized values
                formData[key] = sanitizedValue;
            }
            
            return { isValid: errors.length === 0, errors, sanitizedData: formData };
        }

        // Enhanced 3D Cosmic Particle System Integration
        function initEnhancedCosmicParticles() {
            // Initialize enhanced 3D particle system with user's cosmic data
            if (typeof initCosmicParticles === 'function' && currentUserData) {
                const userCosmicData = {
                    element: currentUserData.element || 'Fire',
                    galacticTone: currentUserData.galacticTone || 1,
                    daySign: currentUserData.daySign || 'Ahau',
                    lifePath: currentUserData.lifePath || 5,
                    kinNumber: currentUserData.kinNumber || 1,
                    direction: currentUserData.direction || 'East',
                    color: currentUserData.color || 'Red'
                };
                
                console.log('Initializing enhanced cosmic particles with user data:', userCosmicData);
                initCosmicParticles('cosmic-particles-dashboard', userCosmicData);
            } else {
                console.warn('Enhanced cosmic particles not available or user data not loaded');
            }
        }

        // Interactive 3D Particle System for Magical Header
        function initMagicalParticleSystem() {
            const canvas = document.getElementById('particleCanvas');
            const ctx = canvas.getContext('2d');
            const titleContainer = document.getElementById('magicalTitle');
            const titleText = document.getElementById('magicalTitleText');
            
            // Set canvas size
            function resizeCanvas() {
                canvas.width = titleContainer.offsetWidth;
                canvas.height = titleContainer.offsetHeight;
            }
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // Particle system
            const particles = [];
            const particleCount = 50;
            
            class MagicalParticle {
                constructor() {
                    this.reset();
                    this.life = Math.random() * 100;
                }
                
                reset() {
                    this.x = Math.random() * canvas.width;
                    this.y = Math.random() * canvas.height;
                    this.vx = (Math.random() - 0.5) * 0.5;
                    this.vy = (Math.random() - 0.5) * 0.5;
                    this.life = 100;
                    this.decay = Math.random() * 0.5 + 0.5;
                    this.size = Math.random() * 3 + 1;
                    this.color = `hsl(${Math.random() * 60 + 240}, 70%, 60%)`;
                }
                
                update() {
                    this.x += this.vx;
                    this.y += this.vy;
                    this.life -= this.decay;
                    
                    if (this.life <= 0) {
                        this.reset();
                    }
                    
                    // Add attraction to cursor
                    const titleRect = titleText.getBoundingClientRect();
                    const centerX = canvas.width / 2;
                    const centerY = canvas.height / 2;
                    const dx = centerX - this.x;
                    const dy = centerY - this.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < 100) {
                        this.vx += dx * 0.0001;
                        this.vy += dy * 0.0001;
                    }
                }
                
                draw() {
                    ctx.save();
                    ctx.globalAlpha = this.life / 100;
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                }
            }
            
            // Initialize particles
            for (let i = 0; i < particleCount; i++) {
                particles.push(new MagicalParticle());
            }
            
            // Animation loop
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                particles.forEach(particle => {
                    particle.update();
                    particle.draw();
                });
                
                requestAnimationFrame(animate);
            }
            
            animate();
            
            // Interactive effects
            titleText.addEventListener('mouseenter', () => {
                titleText.style.transform = 'scale(1.05) rotateY(5deg)';
                titleText.style.textShadow = '0 0 50px rgba(139, 92, 246, 0.6)';
                
                // Add burst of particles
                for (let i = 0; i < 20; i++) {
                    const particle = new MagicalParticle();
                    particle.x = canvas.width / 2;
                    particle.y = canvas.height / 2;
                    particle.vx = (Math.random() - 0.5) * 3;
                    particle.vy = (Math.random() - 0.5) * 3;
                    particles.push(particle);
                }
            });
            
            titleText.addEventListener('mouseleave', () => {
                titleText.style.transform = 'scale(1) rotateY(0deg)';
                titleText.style.textShadow = '0 0 30px rgba(139, 92, 246, 0.3)';
            });
            
            titleText.addEventListener('click', () => {
                // Magical burst effect
                titleText.style.animation = 'none';
                titleText.style.transform = 'scale(1.1) rotateY(10deg)';
                titleText.style.textShadow = '0 0 60px rgba(139, 92, 246, 0.8)';
                
                setTimeout(() => {
                    titleText.style.animation = 'magicalPulse 3s ease-in-out infinite';
                    titleText.style.transform = 'scale(1) rotateY(0deg)';
                    titleText.style.textShadow = '0 0 30px rgba(139, 92, 246, 0.3)';
                }, 300);
                
                // Create massive particle burst
                for (let i = 0; i < 50; i++) {
                    const particle = new MagicalParticle();
                    particle.x = canvas.width / 2;
                    particle.y = canvas.height / 2;
                    particle.vx = (Math.random() - 0.5) * 5;
                    particle.vy = (Math.random() - 0.5) * 5;
                    particle.size = Math.random() * 5 + 2;
                    particles.push(particle);
                }
            });
        }
        
        // Create magical sparkles around the header
        function createMagicalSparkles() {
            const header = document.querySelector('.header');
            const sparkleCount = 15;
            
            for (let i = 0; i < sparkleCount; i++) {
                const sparkle = document.createElement('div');
                sparkle.className = 'magical-sparkle';
                sparkle.style.left = Math.random() * 100 + '%';
                sparkle.style.top = Math.random() * 100 + '%';
                sparkle.style.animationDelay = Math.random() * 2 + 's';
                header.appendChild(sparkle);
            }
            
            // Create floating orbs
            for (let i = 0; i < 8; i++) {
                const orb = document.createElement('div');
                orb.className = 'magical-orb';
                orb.style.left = Math.random() * 100 + '%';
                orb.style.top = Math.random() * 100 + '%';
                orb.style.animationDelay = Math.random() * 4 + 's';
                header.appendChild(orb);
            }
        }

        // Check authentication
        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                console.log('No token found, redirecting to homepage');
                window.location.href = '/';
                return false;
            }
            return true;
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkAuth()) return;
            
            loadUserData();
            generatePersonalizedSnapshot();
            
            // Initialize magical effects
            setTimeout(() => {
                initMagicalParticleSystem();
                createMagicalSparkles();
            }, 500);
        });

        // Load user data
        async function loadUserData() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    console.log('No token found, redirecting to homepage');
                    window.location.href = '/';
                    return;
                }

                console.log('Loading user data with token:', token.substring(0, 20) + '...');
                
                const response = await fetch('/api/user', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                console.log('API response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API error:', response.status, errorText);
                    throw new Error(`Failed to load user data: ${response.status} ${errorText}`);
                }

                currentUserData = await response.json();
                currentUser = currentUserData;
                
                console.log('User data loaded successfully:', currentUserData);
                
                // Update UI
                const userNameElement = document.getElementById('userName');
                if (userNameElement) {
                    userNameElement.textContent = currentUserData.first_name || 'Sacred Soul';
                }
                
                // Update Sacred Signature and Soul Mission
                const sacredSignature = `${currentUserData.day_sign || 'Maya'} ${currentUserData.galactic_tone || 'Cosmic'}`;
                const soulMission = `${currentUserData.element || 'Spiritual'} ${currentUserData.direction || 'Path'} Guide`;
                
                updateElementText('sacredSignature', sacredSignature);
                updateElementText('soulMission', soulMission);
                
                // Generate soul essence
                generateSoulEssence(currentUserData);
                
                // Populate cosmic elements
                populateCosmicElements(currentUserData);
                
                // Generate personalized snapshots for each element
                generateElementSnapshots();
                
            } catch (error) {
                console.error('Error loading user data:', error);
                
                // Instead of redirecting immediately, show error message
                const errorDiv = document.createElement('div');
                errorDiv.innerHTML = `
                    <div style="background: rgba(255,0,0,0.1); color: white; padding: 20px; margin: 20px; border-radius: 10px;">
                        <h3>Error Loading Dashboard</h3>
                        <p>Error: ${error.message}</p>
                        <p>Please check the console for more details.</p>
                        <button onclick="window.location.href='/'" style="background: #ff4444; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Return to Homepage</button>
                    </div>
                `;
                document.body.insertBefore(errorDiv, document.body.firstChild);
            }
        }

        // Extract readable value from sign objects
        function extractSignValue(signData) {
            if (!signData) return 'Unknown';
            
            // If it's a string that looks like JSON, parse it first
            if (typeof signData === 'string') {
                // Check if it's a JSON string
                if (signData.startsWith('{') && signData.endsWith('}')) {
                    try {
                        const parsed = JSON.parse(signData);
                        return parsed.name || parsed.meaning || parsed.value || 'Unknown';
                    } catch (e) {
                        console.warn('Failed to parse JSON string:', signData);
                        return 'Unknown';
                    }
                }
                // If it's a regular string, return it (unless it's still showing JSON structure)
                if (signData.includes('"name":') || signData.includes('"meaning":')) {
                    // This is malformed JSON, try to extract the name value
                    try {
                        const nameMatch = signData.match(/"name":\s*"([^"]+)"/);
                        if (nameMatch) return nameMatch[1];
                        const meaningMatch = signData.match(/"meaning":\s*"([^"]+)"/);
                        if (meaningMatch) return meaningMatch[1];
                    } catch (e) {
                        console.warn('Failed to extract from malformed JSON:', signData);
                    }
                    return 'Unknown';
                }
                return signData;
            }
            
            // If it's an object, try to extract the name or readable value
            if (typeof signData === 'object') {
                return signData.name || signData.meaning || signData.value || 'Unknown';
            }
            
            return signData || 'Unknown';
        }

        // Populate cosmic elements
        function populateCosmicElements(userData) {
            const cosmicProfile = userData.cosmic_profile || {};
            
            // Core Maya Signature
            updateElementText('daySign', cosmicProfile.day_sign?.name || userData.day_sign);
            updateElementText('galacticTone', cosmicProfile.galactic_tone?.name || userData.galactic_tone);
            updateElementText('kinNumber', cosmicProfile.kin_number || userData.kin_number);
            updateElementText('element', cosmicProfile.element || userData.element);
            updateElementText('direction', cosmicProfile.direction || userData.direction);
            
            // Sacred Calendar Cycles
            updateElementText('trecena', cosmicProfile.trecena);
            updateElementText('wavespell', cosmicProfile.wavespell);
            updateElementText('castle', cosmicProfile.castle);
            updateElementText('harmonic', cosmicProfile.harmonic);
            updateElementText('colorFamily', cosmicProfile.color_family);
            updateElementText('tribe', cosmicProfile.tribe);
            updateElementText('galacticActivationPortal', cosmicProfile.galactic_activation_portal);
            
            // Maya Cross & Extended Calendar
            updateElementText('guideSign', extractSignValue(cosmicProfile.guide_sign));
            updateElementText('antipodeSign', extractSignValue(cosmicProfile.antipode_sign));
            updateElementText('occultSign', extractSignValue(cosmicProfile.occult_sign));
            updateElementText('lordOfNight', cosmicProfile.lord_of_night);
            updateElementText('haabDate', cosmicProfile.haab_date);
            updateElementText('longCount', cosmicProfile.long_count);
            updateElementText('yearBearer', cosmicProfile.year_bearer);
            updateElementText('moonPhase', cosmicProfile.moon_phase);
            
            // Spiritual & Natural Elements
            updateElementText('spiritAnimal', cosmicProfile.spirit_animal);
            updateElementText('crystalAlly', cosmicProfile.crystal_ally);
            updateElementText('plantMedicine', cosmicProfile.plant_medicine);
            updateElementText('chakraResonance', cosmicProfile.chakra_resonance);
            updateElementText('humanDesignType', cosmicProfile.human_design_type);
            updateElementText('treeOfLifePrimary', cosmicProfile.tree_of_life_primary);
            updateElementText('treeOfLifeSecondary', cosmicProfile.tree_of_life_secondary);
            
            // Additional Cosmic Elements section removed - eliminated redundancy with individual element popups
            
            // Update welcome header with Birth Time, Birth Location, and Trecena
            updateElementText('welcomeBirthTime', userData.birth_time || 'Not specified');
            updateElementText('welcomeBirthLocation', userData.birth_location || 'Not specified');
            updateElementText('welcomeTrecena', cosmicProfile.trecena || 'Loading...');
            
            // Update main features previews
            const cosmicBlueprintPreview = document.getElementById('cosmicBlueprintPreview');
            if (cosmicBlueprintPreview) {
                cosmicBlueprintPreview.textContent = userData.cosmic_profile ? 
                    `Your cosmic signature: ${userData.cosmic_profile.day_sign || userData.day_sign || 'Unknown'} ${userData.cosmic_profile.galactic_tone || userData.galactic_tone || ''} - ${userData.cosmic_profile.element || userData.element || 'Unknown'} energy with ${userData.cosmic_profile.direction || userData.direction || 'Unknown'} direction` : 
                    'Loading your cosmic blueprint preview...';
            }

            const soulContractPreview = document.getElementById('soulContractPreview');
            if (soulContractPreview) {
                soulContractPreview.textContent = userData.blueprint_summary ? 
                    userData.blueprint_summary.substring(0, 120) + '...' : 
                    'Loading your soul contract preview...';
            }
        }

        // Generate enhanced magical soul essence introduction
        function generateSoulEssence(userData) {
            const soulEssenceElement = document.getElementById('soulEssenceContent');
            
            // Extract user's cosmic data
            const cosmicProfile = userData.cosmic_profile || {};
            const daySign = cosmicProfile.day_sign?.name || userData.day_sign || 'Unknown';
            const galacticTone = cosmicProfile.galactic_tone?.name || userData.galactic_tone || 'Unknown';
            const element = cosmicProfile.element || userData.element || 'Unknown';
            const direction = cosmicProfile.direction || userData.direction || 'Unknown';
            const spiritAnimal = cosmicProfile.spirit_animal || 'Unknown';
            const userName = userData.first_name || userData.full_name || 'Sacred Soul';
            
            // Enhanced soul essence templates with magical elements
            const soulEssences = {
                'Fire': {
                    essence: 'Sacred Fire Keeper',
                    description: 'Your soul blazes with transformative fire energy, igniting passion and creativity wherever you go. You are a catalyst for change and spiritual awakening.',
                    symbol: '🔥',
                    bgGradient: 'linear-gradient(135deg, #ff6b6b, #ffd700, #ff4757)',
                    energy: 'Passionate • Transformative • Inspiring',
                    archetype: 'The Divine Catalyst',
                    mission: 'To ignite the sacred flame of transformation in yourself and others',
                    mysticalElements: ['🌟', '✨', '💫', '🔮']
                },
                'Water': {
                    essence: 'Sacred Water Bearer',
                    description: 'Your soul flows with the eternal wisdom of water, carrying healing energy and emotional depth. You are a natural healer and intuitive guide.',
                    symbol: '🌊',
                    bgGradient: 'linear-gradient(135deg, #00f5ff, #0084ff, #8a2be2)',
                    energy: 'Healing • Intuitive • Flowing',
                    archetype: 'The Divine Healer',
                    mission: 'To bring emotional healing and spiritual cleansing to the world',
                    mysticalElements: ['🌙', '💧', '🔮', '✨']
                },
                'Earth': {
                    essence: 'Sacred Earth Guardian',
                    description: 'Your soul is grounded in the ancient wisdom of Earth, providing stability and nurturing energy. You are a manifestor of dreams into reality.',
                    symbol: '🌍',
                    bgGradient: 'linear-gradient(135deg, #00ff7f, #32cd32, #8b4513)',
                    energy: 'Grounded • Nurturing • Manifesting',
                    archetype: 'The Divine Manifestor',
                    mission: 'To ground spiritual wisdom into tangible, nurturing reality',
                    mysticalElements: ['🌿', '🌳', '💎', '✨']
                },
                'Air': {
                    essence: 'Sacred Wind Walker',
                    description: 'Your soul soars with the limitless energy of air, carrying divine inspiration and clear communication. You are a messenger of cosmic wisdom.',
                    symbol: '💨',
                    bgGradient: 'linear-gradient(135deg, #87ceeb, #9370db, #ffd700)',
                    energy: 'Inspiring • Communicative • Free',
                    archetype: 'The Divine Messenger',
                    mission: 'To carry divine messages and inspire others through clear communication',
                    mysticalElements: ['💫', '🌟', '🦋', '✨']
                }
            };
            
            // Default for unknown elements
            const defaultEssence = {
                essence: 'Sacred Cosmic Explorer',
                description: 'Your soul carries the infinite mystery of the cosmos, bridging multiple dimensions of existence. You are a unique expression of divine consciousness.',
                symbol: '✨',
                bgGradient: 'linear-gradient(135deg, #9b59b6, #3498db, #e74c3c)',
                energy: 'Mystical • Multi-dimensional • Unique',
                archetype: 'The Divine Explorer',
                mission: 'To explore and integrate the infinite aspects of cosmic consciousness',
                mysticalElements: ['🌌', '🔮', '💫', '✨']
            };
            
            const userEssence = soulEssences[element] || defaultEssence;
            
            // Animate the soul essence reveal with magical effects
            setTimeout(() => {
                soulEssenceElement.innerHTML = `
                    <div style="
                        background: ${userEssence.bgGradient};
                        border-radius: 25px;
                        padding: 30px;
                        margin: 10px 0;
                        position: relative;
                        overflow: hidden;
                        backdrop-filter: blur(10px);
                        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                    ">
                        <!-- Floating mystical elements -->
                        <div style="position: absolute; top: 15px; left: 15px; font-size: 1.2rem; opacity: 0.8; animation: twinkle 3s ease-in-out infinite;">${userEssence.mysticalElements[0]}</div>
                        <div style="position: absolute; top: 15px; right: 15px; font-size: 1.2rem; opacity: 0.8; animation: twinkle 3s ease-in-out infinite 1s;">${userEssence.mysticalElements[1]}</div>
                        <div style="position: absolute; bottom: 15px; left: 15px; font-size: 1.2rem; opacity: 0.8; animation: twinkle 3s ease-in-out infinite 2s;">${userEssence.mysticalElements[2]}</div>
                        <div style="position: absolute; bottom: 15px; right: 15px; font-size: 1.2rem; opacity: 0.8; animation: twinkle 3s ease-in-out infinite 0.5s;">${userEssence.mysticalElements[3]}</div>
                        
                        <!-- Main content -->
                        <div style="display: flex; flex-direction: column; align-items: center; text-align: center; position: relative; z-index: 2;">
                            <div style="
                                font-size: 4rem; 
                                margin-bottom: 20px; 
                                animation: soulPulse 3s ease-in-out infinite;
                                filter: drop-shadow(0 0 20px rgba(255,255,255,0.5));
                            ">${userEssence.symbol}</div>
                            
                            <div style="
                                font-size: 1.6rem; 
                                font-weight: 800; 
                                margin-bottom: 10px; 
                                text-shadow: 0 4px 8px rgba(0,0,0,0.4);
                                animation: textGlow 4s ease-in-out infinite;
                            ">
                                ${userName}, the ${userEssence.essence}
                            </div>
                            
                            <div style="
                                font-size: 1.2rem; 
                                opacity: 0.9; 
                                margin-bottom: 20px; 
                                font-style: italic;
                                text-shadow: 0 2px 4px rgba(0,0,0,0.3);
                            ">
                                ${userEssence.archetype}
                            </div>
                            
                            <div style="
                                font-size: 1rem; 
                                opacity: 0.95; 
                                margin-bottom: 20px;
                                padding: 10px 20px;
                                background: rgba(255,255,255,0.2);
                                border-radius: 15px;
                                backdrop-filter: blur(5px);
                            ">
                                ${userEssence.energy}
                            </div>
                            
                            <div style="
                                font-size: 1.1rem; 
                                line-height: 1.7; 
                                margin-bottom: 25px; 
                                opacity: 0.95;
                                text-shadow: 0 2px 4px rgba(0,0,0,0.3);
                            ">
                                ${userEssence.description}
                            </div>
                            
                            <div style="
                                background: rgba(255,255,255,0.25); 
                                border-radius: 20px; 
                                padding: 20px; 
                                margin-bottom: 20px; 
                                width: 100%;
                                backdrop-filter: blur(10px);
                                border: 2px solid rgba(255,255,255,0.3);
                            ">
                                <div style="
                                    font-size: 1.1rem; 
                                    font-weight: 700; 
                                    margin-bottom: 10px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    gap: 8px;
                                ">
                                    <span style="animation: soulPulse 2s ease-in-out infinite;">🎯</span>
                                    Your Soul Mission
                                </div>
                                <div style="
                                    font-size: 1rem; 
                                    opacity: 0.95; 
                                    font-style: italic;
                                    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
                                ">
                                    ${userEssence.mission}
                                </div>
                            </div>
                            
                            <div style="
                                background: rgba(255,255,255,0.2); 
                                border-radius: 15px; 
                                padding: 15px; 
                                font-size: 0.95rem; 
                                width: 100%;
                                text-shadow: 0 2px 4px rgba(0,0,0,0.3);
                                border: 1px solid rgba(255,255,255,0.3);
                            ">
                                <strong>Sacred Signature:</strong> ${daySign} ${galacticTone} • ${element} ${direction} • ${spiritAnimal}
                            </div>
                        </div>
                    </div>
                `;
            }, 2000);
        }

        // Generate personalized snapshot
        async function generatePersonalizedSnapshot() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/generate-personalized-snapshot', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to generate snapshot');
                }

                const data = await response.json();
                const snapshotElement = document.getElementById('personalizedSnapshotContent');
                if (snapshotElement) {
                    snapshotElement.innerHTML = data.snapshot;
                }
                
            } catch (error) {
                console.error('Error generating snapshot:', error);
                const snapshotElement = document.getElementById('personalizedSnapshotContent');
                if (snapshotElement) {
                    snapshotElement.innerHTML = `
                        🌟 ${currentUserData?.first_name || 'Sacred Soul'}, you are a divine being of light, carrying the wisdom of the cosmos within your soul. Your spiritual journey is uniquely yours, guided by ancient Maya wisdom and cosmic intelligence. The Magic is You! ✨
                    `;
                }
            }
        }

        // Generate element snapshots
        async function generateElementSnapshots() {
            const elements = [
                'daySign', 'galacticTone', 'kinNumber', 'element', 'direction',
                'trecena', 'wavespell', 'castle', 'harmonic', 'colorFamily', 'tribe', 'galacticActivationPortal',
                'guideSign', 'antipodeSign', 'occultSign', 'lordOfNight', 'haabDate', 'longCount', 'yearBearer', 'moonPhase',
                'spiritAnimal', 'crystalAlly', 'plantMedicine', 'chakraResonance', 'humanDesignType', 'treeOfLifePrimary', 'treeOfLifeSecondary',
                'lifePath', 'birthTime', 'birthLocation', 'blueprintSummary'
            ];

            for (const elementId of elements) {
                const elementElement = document.getElementById(elementId);
                const snapshotElement = document.getElementById(elementId + 'Snapshot');
                
                if (!elementElement || !snapshotElement) {
                    console.warn(`Element not found: ${elementId}`);
                    continue;
                }
                
                const elementValue = elementElement.textContent;
                
                try {
                    const snapshot = await generateElementSnapshot(elementId, elementValue);
                    snapshotElement.textContent = snapshot;
                } catch (error) {
                    snapshotElement.textContent = `✨ This ${elementId.replace(/([A-Z])/g, ' $1').toLowerCase()} element connects deeply to your soul journey and cosmic blueprint. Click to discover more insights!`;
                }
            }
        }

        // Generate individual element snapshot
        async function generateElementSnapshot(elementType, elementValue) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/ai-cosmic-explanation', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        element_type: elementType,
                        element_value: elementValue,
                        time_spent: 2,
                        engagement_level: 5
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to generate element snapshot');
                }

                const data = await response.json();
                return data.explanation ? data.explanation.substring(0, 150) + '...' : 'Click to discover your personalized insights!';
                
            } catch (error) {
                return `✨ This ${elementType.replace(/([A-Z])/g, ' $1').toLowerCase()} element holds special significance for your spiritual journey. Click to explore deeper!`;
            }
        }

        // Show element details modal with comprehensive AI explanations
        // Phase 4 Code Cleanup - Enhanced documentation for critical functions (SAFE - Documentation only)
        /**
         * Display detailed information about a cosmic element in a modal.
         * 
         * @param {string} elementType - Type of cosmic element (day_sign, galactic_tone, etc.)
         * @param {string} elementName - Human-readable name of the element
         * @returns {Promise<void>} Opens modal with element details
         * 
         * Critical Function: This function controls 28 cosmic element buttons
         * 
         * Functionality:
         * - Fetches AI-generated element explanation from /api/ai-cosmic-explanation
         * - Displays personalized content in modal popup
         * - Handles loading states and error conditions
         * - Tracks user interactions for personalization
         * 
         * Side Effects:
         * - Opens elementModal with element information
         * - Makes API call to get personalized explanation
         * - Updates modal content with Back to Dashboard and Share Element buttons
         * - Handles authentication and error states
         * 
         * Security:
         * - Uses JWT authentication
         * - Validates element types and names
         * - Sanitizes content display
         */
        async function showElementDetails(elementType, elementName) {
            interactionStartTime = Date.now();
            
            const modal = document.getElementById('elementModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            // Get element value from currentUserData using proper mapping
            const elementValue = getElementValue(elementType, currentUserData);
            
            modalTitle.textContent = `🌟 ${elementName} Insights`;
            modalBody.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 1.2rem; color: #5830a3; margin-bottom: 10px;">
                        <strong>Your ${elementName}:</strong> ${elementValue}
                    </div>
                    <div style="color: #6366f1; font-size: 1rem; line-height: 1.6;">
                        <div style="display: flex; justify-content: center; margin: 20px 0;">
                            <div style="border: 3px solid #8b5cf6; border-radius: 50%; width: 40px; height: 40px; border-top: 3px solid transparent; animation: spin 1s linear infinite;"></div>
                        </div>
                        Loading your comprehensive personalized spiritual insights...
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
            
            try {
                const token = localStorage.getItem('token');
                
                // Call the comprehensive AI explanation API
                const response = await fetch('/api/ai-cosmic-explanation', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        element_type: elementType,
                        element_value: elementValue,
                        time_spent: 0,
                        engagement_level: 8
                    })
                });

                if (!response.ok) {
                    throw new Error(`Failed to load element details: ${response.status}`);
                }

                const data = await response.json();
                
                // Display comprehensive AI-generated explanation
                modalBody.innerHTML = `
                    <div style="line-height: 1.6; color: #1e3a8a;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <h3 style="color: #5830a3; font-size: 1.5rem; margin-bottom: 10px;">
                                🌟 ${elementName}: ${elementValue}
                            </h3>
                        </div>
                        <div style="color: #374151; font-size: 1rem; line-height: 1.7; max-height: 60vh; overflow-y: auto; padding: 10px;">
                            ${data.explanation ? formatExplanationText(data.explanation) : getBasicFallback(elementName, elementValue)}
                        </div>

                        <div style="margin-top: 30px; text-align: center; border-top: 2px solid #e5e7eb; padding-top: 20px;">
                            <button onclick="document.getElementById('elementModal').style.display='none'" style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); color: white; border: none; padding: 12px 24px; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-right: 15px; transition: all 0.3s ease;">
                                🏠 Back to Dashboard
                            </button>
                            <button onclick="shareCosmicElement('${elementName}', '${elementValue}')" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 12px 24px; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                                🔗 Share Element
                            </button>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error fetching element explanation:', error);
                
                // Show detailed fallback with user's name and cosmic context
                modalBody.innerHTML = `
                    <div style="line-height: 1.6; color: #1e3a8a;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <h3 style="color: #5830a3; font-size: 1.5rem; margin-bottom: 10px;">
                                🌟 ${elementName}: ${elementValue}
                            </h3>
                        </div>
                        <div style="color: #374151; font-size: 1rem; line-height: 1.7;">
                            ${getDetailedFallback(elementName, elementValue, currentUserData)}
                        </div>
                        <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                            <p style="color: #ef4444; font-size: 0.9rem; font-style: italic;">
                                🔄 AI analysis temporarily unavailable - showing sacred wisdom guidance
                            </p>
                        </div>
                        <div style="margin-top: 30px; text-align: center; border-top: 2px solid #e5e7eb; padding-top: 20px;">
                            <button onclick="document.getElementById('elementModal').style.display='none'" style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); color: white; border: none; padding: 12px 24px; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-right: 15px; transition: all 0.3s ease;">
                                🏠 Back to Dashboard
                            </button>
                            <button onclick="shareCosmicElement('${elementName}', '${elementValue}')" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 12px 24px; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                                🔗 Share Element
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // Helper function to get element value with proper handling
        function getElementValue(elementType, userData) {
            if (!userData) return 'Unknown';
            
            const cosmicProfile = userData.cosmic_profile || {};
            
            // Handle different element types with proper data extraction
            switch (elementType) {
                case 'day_sign':
                    return cosmicProfile.day_sign?.name || userData.day_sign || 'Unknown';
                case 'galactic_tone':
                    return cosmicProfile.galactic_tone?.name || userData.galactic_tone || 'Unknown';
                case 'element':
                    return cosmicProfile.element || userData.element || 'Unknown';
                case 'direction':
                    return cosmicProfile.direction || userData.direction || 'Unknown';
                case 'kin_number':
                    return cosmicProfile.kin_number || userData.kin_number || 'Unknown';
                case 'spirit_animal':
                    return cosmicProfile.spirit_animal || userData.spirit_animal || 'Unknown';
                case 'crystal_ally':
                    return cosmicProfile.crystal_ally || userData.crystal_ally || 'Unknown';
                case 'plant_medicine':
                    return cosmicProfile.plant_medicine || userData.plant_medicine || 'Unknown';
                case 'chakra_resonance':
                    return cosmicProfile.chakra_resonance || userData.chakra_resonance || 'Unknown';
                case 'human_design_type':
                    return cosmicProfile.human_design_type || userData.human_design_type || 'Unknown';
                case 'guide_sign':
                    return extractSignValue(cosmicProfile.guide_sign) || 'Unknown';
                case 'antipode_sign':
                    return extractSignValue(cosmicProfile.antipode_sign) || 'Unknown';
                case 'occult_sign':
                    return extractSignValue(cosmicProfile.occult_sign) || 'Unknown';
                case 'lord_of_night':
                    return cosmicProfile.lord_of_night || 'Unknown';
                case 'haab_date':
                    return cosmicProfile.haab_date || 'Unknown';
                case 'long_count':
                    return cosmicProfile.long_count || 'Unknown';
                case 'year_bearer':
                    return cosmicProfile.year_bearer || 'Unknown';
                case 'moon_phase':
                    return cosmicProfile.moon_phase || 'Unknown';
                case 'trecena':
                    return cosmicProfile.trecena || 'Unknown';
                case 'wavespell':
                    return cosmicProfile.wavespell || 'Unknown';
                case 'castle':
                    return cosmicProfile.castle || 'Unknown';
                case 'harmonic':
                    return cosmicProfile.harmonic || 'Unknown';
                case 'color_family':
                    return cosmicProfile.color_family || 'Unknown';
                case 'tribe':
                    return cosmicProfile.tribe || 'Unknown';
                case 'galactic_activation_portal':
                    return cosmicProfile.galactic_activation_portal || 'Unknown';
                case 'tree_of_life_primary':
                    return cosmicProfile.tree_of_life_primary || 'Unknown';
                case 'tree_of_life_secondary':
                    return cosmicProfile.tree_of_life_secondary || 'Unknown';
                default:
                    return cosmicProfile[elementType] || userData[elementType] || 'Unknown';
            }
        }

        // Helper function to format explanation text with better HTML structure
        function formatExplanationText(explanation) {
            if (!explanation) return 'No explanation available.';
            
            // Convert markdown-style formatting to HTML
            let formatted = explanation
                .replace(/\*\*(.*?)\*\*/g, '<strong style="color: #5830a3;">$1</strong>')
                .replace(/\*(.*?)\*/g, '<em style="color: #6366f1;">$1</em>')
                .replace(/\n\n/g, '</p><p style="margin-bottom: 15px;">')
                .replace(/\n/g, '<br>');
            
            return `<p style="margin-bottom: 15px;">${formatted}</p>`;
        }

        // Helper function for basic fallback content
        function getBasicFallback(elementName, elementValue) {
            const userName = currentUserData?.first_name || 'Sacred Soul';
            return `
                <p style="margin-bottom: 15px;"><strong>Dear ${userName},</strong></p>
                <p style="margin-bottom: 15px;">Your ${elementName} carries profound wisdom for your spiritual journey. This sacred element is intricately connected to your soul's purpose and your unique cosmic blueprint.</p>
                <p style="margin-bottom: 15px;">Through the ancient Maya wisdom traditions, this element reveals important aspects of your spiritual nature and provides guidance for your personal growth and enlightenment.</p>
                <p style="margin-bottom: 15px;"><em>The Magic is You!</em> ✨</p>
            `;
        }

        // Helper function for detailed fallback content with cosmic context
        function getDetailedFallback(elementName, elementValue, userData) {
            const userName = userData?.first_name || 'Sacred Soul';
            const daySign = userData?.daySign || userData?.day_sign || 'your sacred day sign';
            const galacticTone = userData?.galacticTone || userData?.galactic_tone || 'your galactic tone';
            const element = userData?.element || 'your spiritual element';
            
            return `
                <p style="margin-bottom: 15px;"><strong>Dear ${userName},</strong></p>
                <p style="margin-bottom: 15px;">Your ${elementName} of <strong style="color: #5830a3;">${elementValue}</strong> is a sacred thread in the tapestry of your cosmic identity. This element works in harmony with your ${daySign} essence and ${galacticTone} vibration to create your unique spiritual signature.</p>
                <p style="margin-bottom: 15px;">In the ancient Maya tradition, each element of your cosmic blueprint reveals specific gifts, challenges, and spiritual opportunities. Your ${elementName} influences how you connect with the sacred energies of ${element} and shapes your path of personal transformation.</p>
                <p style="margin-bottom: 15px;"><strong style="color: #6366f1;">Sacred Guidance:</strong> Meditate on this element and allow its wisdom to reveal deeper truths about your spiritual journey. Each aspect of your cosmic blueprint is a doorway to greater self-understanding and soul awakening.</p>
                <p style="margin-bottom: 15px;"><em>The Magic is You!</em> ✨</p>
            `;
        }

        // Show cosmic blueprint (basic analysis)
        // Phase 4 Code Cleanup - Enhanced documentation for critical functions (SAFE - Documentation only)
        /**
         * Display comprehensive cosmic blueprint in a modal.
         * 
         * @returns {Promise<void>} Opens modal with cosmic blueprint details
         * 
         * Critical Function: This function controls the main "Cosmic Blueprint" button
         * 
         * Functionality:
         * - Fetches personalized cosmic blueprint analysis from /api/generate-cosmic-blueprint
         * - Displays comprehensive 6-section spiritual analysis
         * - Handles loading states and error conditions
         * - Provides download and share functionality
         * 
         * Side Effects:
         * - Opens elementModal with blueprint information
         * - Makes API call to get AI-generated analysis
         * - Updates modal content with Back to Dashboard and Share Element buttons
         * - Handles authentication and error states
         * 
         * Security:
         * - Uses JWT authentication
         * - Validates response data
         * - Sanitizes content display
         */
        async function showCosmicBlueprint() {
            try {
                const token = localStorage.getItem('token');
                const modal = document.getElementById('elementModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalBody = document.getElementById('modalBody');
                
                modalTitle.textContent = '🌙 Your Sacred Cosmic Blueprint';
                modalBody.innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Generating your cosmic blueprint analysis...</p>
                    </div>
                `;
                modal.style.display = 'block';
                
                const response = await fetch('/api/generate-enhanced-blueprint-analysis', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to generate cosmic blueprint');
                }

                const data = await response.json();
                
                modalBody.innerHTML = `
                    <div style="line-height: 1.6; color: #1e3a8a;">
                        ${data.full_analysis ? data.full_analysis.replace(/\n/g, '<br>') : data.fallback_analysis}
                    </div>
                    <div style="margin-top: 30px; text-align: center; border-top: 2px solid #e5e7eb; padding-top: 20px;">
                        <button onclick="document.getElementById('elementModal').style.display='none'" style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); color: white; border: none; padding: 12px 24px; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-right: 15px; transition: all 0.3s ease;">
                            🏠 Back to Dashboard
                        </button>
                        <button onclick="shareCosmicBlueprint()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 12px 24px; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                            🔗 Share Cosmic Blueprint
                        </button>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error generating cosmic blueprint:', error);
                const modal = document.getElementById('elementModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalBody = document.getElementById('modalBody');
                
                modalTitle.textContent = '🌙 Your Sacred Cosmic Blueprint';
                modalBody.innerHTML = `
                    <div style="background: linear-gradient(135deg, #8B4513, #DAA520); padding: 30px; border-radius: 20px; color: white; font-family: 'Cinzel', serif; text-align: center; margin: 20px 0;">
                        <h2 style="font-size: 2rem; margin-bottom: 10px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                            🌙 Your Sacred Cosmic Blueprint 🌙
                        </h2>
                        <p style="font-size: 1.1rem; opacity: 0.9; margin-bottom: 0;">
                            Blessed by Ancient Maya Wisdom
                        </p>
                    </div>
                    <div style="background: rgba(218, 165, 32, 0.1); padding: 25px; border-radius: 15px; border-left: 4px solid #DAA520; font-family: 'Inter', sans-serif; line-height: 1.8; color: #2D1810;">
                        <p style="margin-bottom: 20px; font-size: 1.1rem;">Dear ${currentUserData?.first_name || 'Sacred Soul'}, your cosmic blueprint reveals the sacred wisdom encoded in your soul's journey. You are a divine being of light, carrying the ancient knowledge of the Maya within your cosmic signature.</p>
                        <p style="margin-bottom: 20px; font-size: 1.1rem;">Your spiritual path is uniquely yours, guided by the cosmic energies that flow through your being. Trust in your inner wisdom and remember always: The Magic is You!</p>
                    </div>
                    <div style="margin-top: 30px; text-align: center; border-top: 2px solid #e5e7eb; padding-top: 20px;">
                        <button onclick="document.getElementById('elementModal').style.display='none'" style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); color: white; border: none; padding: 12px 24px; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-right: 15px; transition: all 0.3s ease;">
                            🏠 Back to Dashboard
                        </button>
                        <button onclick="shareCosmicBlueprint()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 12px 24px; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                            🔗 Share Cosmic Blueprint
                        </button>
                    </div>
                `;
                modal.style.display = 'block';
            }
        }

        // Activate Soul Contract Ceremony - Transform into Immersive Experience
        async function activateSoulCeremony() {
            try {
                console.log('🌟 Activating Soul Contract Ceremony...');
                
                // Show loading state
                showLoadingState();
                
                // Load ceremony portal script if not already loaded
                if (typeof CeremonyPortal === 'undefined') {
                    console.log('Loading ceremony portal script...');
                    await loadCeremonyPortalScript();
                }
                
                // Initialize ceremony portal with current user's cosmic data
                const ceremonyPortal = new CeremonyPortal(currentUserData);
                
                // Store ceremony portal instance globally for access
                window.activeCeremonyPortal = ceremonyPortal;
                
                // Activate the ceremony
                await ceremonyPortal.activateCeremony();
                
            } catch (error) {
                console.error('Error activating soul ceremony:', error);
                hideLoadingState();
                // Enhanced fallback ceremony
                createEnhancedCeremonyFallback();
            }
        }
        
        // Load ceremony portal script dynamically
        function loadCeremonyPortalScript() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = '/static/js/ceremony-portal.js';
                script.onload = () => {
                    console.log('Ceremony portal loaded successfully');
                    resolve();
                };
                script.onerror = () => {
                    console.error('Failed to load ceremony portal script');
                    reject(new Error('Script load failed'));
                };
                document.head.appendChild(script);
            });
        }
        
        // Show loading state
        function showLoadingState() {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'ceremony-loading';
            loadingDiv.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; justify-content: center; align-items: center;">
                    <div style="text-align: center; color: white;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">🌟</div>
                        <div style="font-size: 1.5rem; margin-bottom: 1rem;">Activating Sacred Ceremony...</div>
                        <div style="font-size: 1rem; opacity: 0.8;">Connecting to cosmic energies...</div>
                    </div>
                </div>
            `;
            document.body.appendChild(loadingDiv);
        }
        
        // Hide loading state
        function hideLoadingState() {
            const loadingDiv = document.getElementById('ceremony-loading');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }
        
        // Enhanced ceremony fallback with immersive experience
        function createEnhancedCeremonyFallback() {
            hideLoadingState();
            
            const ceremonyDiv = document.createElement('div');
            ceremonyDiv.id = 'ceremony-fallback';
            ceremonyDiv.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column;">
                    <div style="text-align: center; color: white; max-width: 600px; padding: 2rem;">
                        <div style="font-size: 4rem; margin-bottom: 2rem; animation: pulse 2s infinite;">🌟</div>
                        <h2 style="font-size: 2.5rem; margin-bottom: 1rem; font-family: 'Playfair Display', serif;">Sacred Soul Contract Ceremony</h2>
                        <p style="font-size: 1.2rem; margin-bottom: 2rem; opacity: 0.9; line-height: 1.6;">
                            Welcome to your sacred ceremony, ${currentUserData?.first_name || 'Sacred Soul'}. 
                            Your cosmic blueprint reveals the divine wisdom encoded in your soul's journey.
                        </p>
                        <div style="background: rgba(255,255,255,0.1); padding: 2rem; border-radius: 1rem; margin-bottom: 2rem;">
                            <h3 style="font-size: 1.5rem; margin-bottom: 1rem; color: #ffd700;">Your Sacred Signature</h3>
                            <p style="font-size: 1.1rem; opacity: 0.9;">
                                Day Sign: ${currentUserData?.day_sign || 'Unknown'}<br>
                                Galactic Tone: ${currentUserData?.galactic_tone || 'Unknown'}<br>
                                Life Path: ${currentUserData?.life_path || 'Sacred Journey'}
                            </p>
                        </div>
                        <div style="display: flex; gap: 1rem; justify-content: center;">
                            <button onclick="generateDetailedSoulContract(); document.getElementById('ceremony-fallback').remove();" 
                                    style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); color: white; border: none; padding: 12px 24px; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer;">
                                📜 View Soul Contract
                            </button>
                            <button onclick="document.getElementById('ceremony-fallback').remove();" 
                                    style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 12px 24px; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer;">
                                ✨ Return to Dashboard
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(ceremonyDiv);
        }


        // Generate detailed soul contract with all 6 sections (kept as fallback)
        // Phase 4 Code Cleanup - Enhanced documentation for critical functions (SAFE - Documentation only)
        /**
         * Generate and display detailed soul contract in a modal.
         * 
         * @returns {Promise<void>} Opens modal with soul contract details
         * 
         * Critical Function: This function controls the "Soul Contract" button
         * 
         * Functionality:
         * - Fetches personalized soul contract from /api/generate-soul-contract
         * - Displays comprehensive 8-section transformative spiritual document
         * - Handles loading states and error conditions
         * - Provides download and share functionality
         * 
         * Side Effects:
         * - Opens elementModal with soul contract information
         * - Makes API call to get AI-generated soul contract
         * - Updates modal content with Back to Dashboard and Share Element buttons
         * - Handles authentication and error states
         * 
         * Security:
         * - Uses JWT authentication
         * - Validates response data
         * - Sanitizes content display
         */
        async function generateDetailedSoulContract() {
            try {
                const token = localStorage.getItem('token');
                const modal = document.getElementById('elementModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalBody = document.getElementById('modalBody');
                
                modalTitle.textContent = '📜 Your Sacred Soul Contract';
                modalBody.innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Generating your detailed soul contract with Soul Origins, Sacred Gifts, Growth Challenges, Destiny Mission, Daily Practices, and Cosmic Signature Wisdom...</p>
                    </div>
                `;
                modal.style.display = 'block';
                
                const response = await fetch('/api/generate-enhanced-soul-contract', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to generate soul contract');
                }

                const data = await response.json();
                
                modalBody.innerHTML = `
                    <div style="line-height: 1.6; color: #1e3a8a;">
                        ${data.contract ? data.contract.replace(/\n/g, '<br>') : 'Your detailed soul contract is being prepared...'}
                    </div>
                    <div style="margin-top: 30px; text-align: center; border-top: 2px solid #e5e7eb; padding-top: 20px;">
                        <button onclick="document.getElementById('elementModal').style.display='none'" style="background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%); color: white; border: none; padding: 12px 24px; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-right: 15px; transition: all 0.3s ease;">
                            🏠 Back to Dashboard
                        </button>
                        <button onclick="shareSoulContract()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 12px 24px; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                            🔗 Share Soul Contract
                        </button>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error generating soul contract:', error);
                const modal = document.getElementById('elementModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalBody = document.getElementById('modalBody');
                
                modalTitle.textContent = '📜 Your Sacred Soul Contract';
                
                // Use the detailed formatted soul contract from the app.py function
                if (currentUserData && currentUserData.cosmic_profile) {
                    const cosmicProfile = currentUserData.cosmic_profile;
                    const daySign = cosmicProfile.day_sign?.name || 'Unknown';
                    const galacticTone = cosmicProfile.galactic_tone?.name || 'Unknown';
                    const element = cosmicProfile.element || 'Unknown';
                    const direction = cosmicProfile.direction || 'Unknown';
                    
                    modalBody.innerHTML = `
                        <div style="background: linear-gradient(135deg, #8B4513, #DAA520); padding: 30px; border-radius: 20px; color: white; font-family: 'Cinzel', serif; text-align: center; margin: 20px 0;">
                            <h2 style="font-size: 2rem; margin-bottom: 10px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                                🌙 Your Sacred Soul Contract 🌙
                            </h2>
                            <p style="font-size: 1.1rem; opacity: 0.9; margin-bottom: 0;">
                                Blessed by Ancient Maya Wisdom
                            </p>
                        </div>
                        
                        <div style="background: rgba(218, 165, 32, 0.1); padding: 25px; border-radius: 15px; border-left: 4px solid #DAA520; font-family: 'Inter', sans-serif; line-height: 1.8; color: #2D1810;">
                            <h3 style="color: #8B4513; margin-top: 25px; margin-bottom: 15px; font-size: 1.4rem;">🌟 SOUL ORIGINS</h3>
                            <p style="margin-bottom: 20px; font-size: 1.1rem;">You emerged from the sacred lineage of the ${daySign}, blessed child of the ${element} element. Your soul carries the ancient wisdom of the ${direction} direction, where the ${galacticTone} energy flows through your being like a river of cosmic light.</p>
                            
                            <h3 style="color: #8B4513; margin-top: 25px; margin-bottom: 15px; font-size: 1.4rem;">🎁 SACRED GIFTS</h3>
                            <p style="margin-bottom: 20px; font-size: 1.1rem;">Your ${daySign} essence grants you the divine ability to channel ${element} wisdom into practical guidance. The ${galacticTone} vibration empowers you to manifest your highest vision and inspire others through your authentic expression of cosmic truth.</p>
                            
                            <h3 style="color: #8B4513; margin-top: 25px; margin-bottom: 15px; font-size: 1.4rem;">🌱 GROWTH CHALLENGES</h3>
                            <p style="margin-bottom: 20px; font-size: 1.1rem;">Your soul's journey involves learning to balance the powerful ${element} energy within you while staying grounded in earthly wisdom. Transform any challenges into opportunities for deeper spiritual understanding and service to others.</p>
                            
                            <h3 style="color: #8B4513; margin-top: 25px; margin-bottom: 15px; font-size: 1.4rem;">✨ DESTINY MISSION</h3>
                            <p style="margin-bottom: 20px; font-size: 1.1rem;">You have incarnated to embody the sacred teachings of the ${daySign} and share the transformative power of ${element} energy with the world. Your path is one of spiritual leadership, healing, and awakening others to their own cosmic magic.</p>
                            
                            <h3 style="color: #8B4513; margin-top: 25px; margin-bottom: 15px; font-size: 1.4rem;">🧘 DAILY PRACTICES</h3>
                            <p style="margin-bottom: 20px; font-size: 1.1rem;">Connect with your ${daySign} energy through meditation and prayer. Honor the ${element} within you through conscious breathing and visualization. Face the ${direction} direction each morning to align with your cosmic signature and embrace your ${galacticTone} power.</p>
                            
                            <h3 style="color: #8B4513; margin-top: 25px; margin-bottom: 15px; font-size: 1.4rem;">🔮 COSMIC SIGNATURE WISDOM</h3>
                            <p style="margin-bottom: 20px; font-size: 1.1rem;">Your cosmic signature of ${daySign} ${galacticTone} is a sacred gift that connects you to the infinite wisdom of the universe. You are a divine bridge between the earthly and cosmic realms, here to anchor higher consciousness into physical reality. Remember always: The Magic is You!</p>
                        </div>
                        <div style="margin-top: 30px; text-align: center; border-top: 2px solid #e5e7eb; padding-top: 20px;">
                            <button onclick="document.getElementById('elementModal').style.display='none'" style="background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%); color: white; border: none; padding: 12px 24px; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-right: 15px; transition: all 0.3s ease;">
                                🏠 Back to Dashboard
                            </button>
                            <button onclick="shareSoulContract()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 12px 24px; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                                🔗 Share Soul Contract
                            </button>
                        </div>
                    `;
                } else {
                    modalBody.innerHTML = `
                        <div style="background: linear-gradient(135deg, #8B4513, #DAA520); padding: 30px; border-radius: 20px; color: white; font-family: 'Cinzel', serif; text-align: center; margin: 20px 0;">
                            <h2 style="font-size: 2rem; margin-bottom: 10px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                                📜 Your Sacred Soul Contract 📜
                            </h2>
                            <p style="font-size: 1.1rem; opacity: 0.9; margin-bottom: 0;">
                                Blessed by Ancient Maya Wisdom
                            </p>
                        </div>
                        <div style="background: rgba(218, 165, 32, 0.1); padding: 25px; border-radius: 15px; border-left: 4px solid #DAA520; font-family: 'Inter', sans-serif; line-height: 1.8; color: #2D1810;">
                            <p style="margin-bottom: 20px; font-size: 1.1rem;">Dear ${currentUserData?.first_name || 'Sacred Soul'}, your soul contract reveals the sacred agreement you made before incarnating. You are a divine being of light, carrying the ancient knowledge of the Maya within your cosmic signature. The Magic is You!</p>
                        </div>
                        <div style="margin-top: 30px; text-align: center; border-top: 2px solid #e5e7eb; padding-top: 20px;">
                            <button onclick="document.getElementById('elementModal').style.display='none'" style="background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%); color: white; border: none; padding: 12px 24px; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-right: 15px; transition: all 0.3s ease;">
                                🏠 Back to Dashboard
                            </button>
                            <button onclick="shareSoulContract()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 12px 24px; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                                🔗 Share Soul Contract
                            </button>
                        </div>
                    `;
                }
                
                modal.style.display = 'block';
            }
        }

        // Generate soul contract
        async function generateSoulContract() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/generate-enhanced-blueprint-analysis', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to generate analysis');
                }

                const data = await response.json();
                
                // Show in modal
                const modal = document.getElementById('elementModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalBody = document.getElementById('modalBody');
                
                modalTitle.textContent = '🔮 Your Soul Contract';
                modalBody.innerHTML = `
                    <div style="line-height: 1.6; color: #1e3a8a;">
                        ${data.full_analysis ? data.full_analysis.replace(/\n/g, '<br>') : data.fallback_analysis}
                    </div>
                `;
                modal.style.display = 'block';
                
            } catch (error) {
                console.error('Error generating analysis:', error);
                alert('Error generating soul contract. Please try again.');
            }
        }

        // Download cosmic blueprint
        async function downloadCosmicBlueprint() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/download-cosmic-blueprint', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to download blueprint');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `cosmic-blueprint-${currentUserData?.first_name || 'sacred-soul'}.html`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                
            } catch (error) {
                console.error('Error downloading blueprint:', error);
                alert('Error downloading blueprint. Please try again.');
            }
        }

        // Share cosmic blueprint
        async function shareCosmicBlueprint() {
            try {
                const shareData = {
                    title: 'My Sacred Cosmic Blueprint',
                    text: `Discover the magic within! I just generated my personalized Maya cosmic blueprint that reveals my spiritual path and soul purpose. Join me on this enlightening journey at The Magic is You!`,
                    url: window.location.href
                };

                if (navigator.share) {
                    await navigator.share(shareData);
                } else {
                    // Fallback for browsers that don't support Web Share API
                    const shareText = `${shareData.text} ${shareData.url}`;
                    await navigator.clipboard.writeText(shareText);
                    alert('Cosmic blueprint sharing text copied to clipboard!');
                }
            } catch (error) {
                console.error('Error sharing blueprint:', error);
                alert('Error sharing blueprint. Please try again.');
            }
        }

        // Sacred Spiritual Tools Functions
        function openMayaOracle() {
            if (!currentUser || !currentUser.id) {
                alert('Please log in to access the Maya Oracle Cards.');
                return;
            }
            
            // Create and show Maya Oracle modal
            const modalHTML = `
                <div id="oracleModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; display: flex; justify-content: center; align-items: center;">
                    <div style="background: white; padding: 30px; border-radius: 20px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <h2 style="color: #5830a3; font-size: 2rem; margin-bottom: 10px;">🔮 Maya Oracle Cards</h2>
                            <p style="color: #6366f1; font-size: 1.1rem;">Ancient wisdom channeled through sacred cards</p>
                        </div>
                        
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div id="oracleCard" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 30px; border-radius: 15px; margin-bottom: 15px; min-height: 200px; display: flex; flex-direction: column; justify-content: center;">
                                <div style="font-size: 3rem; margin-bottom: 10px;">🔮</div>
                                <h3 id="cardTitle" style="font-size: 1.5rem; margin-bottom: 10px;">Click "Draw Card" to begin</h3>
                                <p id="cardMessage" style="font-size: 1rem; opacity: 0.9;">Focus on your question and draw your sacred card</p>
                            </div>
                            
                            <button onclick="drawOracleCard()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 12px 30px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer; margin-right: 10px;">
                                Draw Card
                            </button>
                            <button onclick="closeOracleModal()" style="background: #6b7280; color: white; padding: 12px 30px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer;">
                                Close
                            </button>
                        </div>
                        
                        <div id="oracleInterpretation" style="background: #f3f4f6; padding: 20px; border-radius: 10px; margin-top: 15px; display: none;">
                            <h4 style="color: #5830a3; margin-bottom: 10px;">Personalized Interpretation</h4>
                            <p id="interpretationText" style="color: #374151; line-height: 1.6;">Loading your personalized guidance...</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        function drawOracleCard() {
            const cardTitle = document.getElementById('cardTitle');
            const cardMessage = document.getElementById('cardMessage');
            const interpretation = document.getElementById('oracleInterpretation');
            const interpretationText = document.getElementById('interpretationText');
            
            // Maya Oracle Cards - 20 sacred cards based on Maya day signs
            const mayaCards = [
                { name: "Imix (Crocodile)", message: "Primal creative force awakens within you", symbol: "🐊" },
                { name: "Ik (Wind)", message: "Communication and inspiration flow freely", symbol: "🌬️" },
                { name: "Akbal (Night)", message: "Trust your intuition and inner wisdom", symbol: "🌙" },
                { name: "Kan (Corn)", message: "Abundance and growth are manifesting", symbol: "🌽" },
                { name: "Chicchan (Serpent)", message: "Transformation and healing energy", symbol: "🐍" },
                { name: "Cimi (Death)", message: "Release what no longer serves you", symbol: "💀" },
                { name: "Manik (Deer)", message: "Spiritual tools and healing gifts", symbol: "🦌" },
                { name: "Lamat (Rabbit)", message: "Fertility and new beginnings", symbol: "🐰" },
                { name: "Muluc (Water)", message: "Emotional purification and flow", symbol: "💧" },
                { name: "Oc (Dog)", message: "Loyalty and emotional guidance", symbol: "🐕" },
                { name: "Chuen (Monkey)", message: "Creativity and playful innovation", symbol: "🐵" },
                { name: "Eb (Grass)", message: "Healing and spiritual nourishment", symbol: "🌱" },
                { name: "Ben (Reed)", message: "Family wisdom and ancestral guidance", symbol: "🎋" },
                { name: "Ix (Jaguar)", message: "Magic and shamanic power", symbol: "🐆" },
                { name: "Men (Eagle)", message: "Higher perspective and vision", symbol: "🦅" },
                { name: "Cib (Owl)", message: "Ancient wisdom and inner knowing", symbol: "🦉" },
                { name: "Caban (Earth)", message: "Grounding and earth connection", symbol: "🌍" },
                { name: "Etznab (Flint)", message: "Clarity and spiritual cutting", symbol: "⚔️" },
                { name: "Cauac (Storm)", message: "Cleansing and transformation", symbol: "⛈️" },
                { name: "Ahau (Sun)", message: "Divine light and enlightenment", symbol: "☀️" }
            ];
            
            const randomCard = mayaCards[Math.floor(Math.random() * mayaCards.length)];
            
            // Update card display
            cardTitle.textContent = randomCard.name;
            cardMessage.textContent = randomCard.message;
            document.querySelector('#oracleCard div').textContent = randomCard.symbol;
            
            // Show interpretation section
            interpretation.style.display = 'block';
            interpretationText.textContent = 'Loading your personalized guidance...';
            
            // Get AI interpretation
            getOracleInterpretation(randomCard);
        }
        
        async function getOracleInterpretation(card) {
            const token = localStorage.getItem('token');
            try {
                const response = await fetch('/api/oracle-interpretation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        card: card,
                        userCosmicProfile: currentUserData
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('interpretationText').innerHTML = result.interpretation;
                } else {
                    document.getElementById('interpretationText').textContent = 'Unable to load interpretation. Please try again.';
                }
            } catch (error) {
                console.error('Oracle interpretation error:', error);
                document.getElementById('interpretationText').textContent = 'Network error. Please check your connection and try again.';
            }
        }
        
        function closeOracleModal() {
            const modal = document.getElementById('oracleModal');
            if (modal) {
                modal.remove();
            }
        }
        
        function openDreamInterpreter() {
            if (!currentUser || !currentUser.id) {
                alert('Please log in to access the Dream Interpreter.');
                return;
            }
            
            const modalHTML = `
                <div id="dreamModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; display: flex; justify-content: center; align-items: center;">
                    <div style="background: white; padding: 30px; border-radius: 20px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <h2 style="color: #5830a3; font-size: 2rem; margin-bottom: 10px;">🌙 Dream Interpreter</h2>
                            <p style="color: #6366f1; font-size: 1.1rem;">AI-powered dream analysis with Maya symbolism</p>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Describe your dream:</label>
                            <textarea id="dreamText" style="width: 100%; height: 120px; padding: 10px; border: 2px solid #d1d5db; border-radius: 8px; font-family: inherit; resize: vertical;" placeholder="Share your dream in detail - include emotions, symbols, colors, people, and any significant moments..."></textarea>
                        </div>
                        
                        <div style="text-align: center; margin-bottom: 20px;">
                            <button onclick="analyzeDream()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 12px 30px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer; margin-right: 10px;">
                                Analyze Dream
                            </button>
                            <button onclick="closeDreamModal()" style="background: #6b7280; color: white; padding: 12px 30px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer;">
                                Close
                            </button>
                        </div>
                        
                        <div id="dreamAnalysis" style="background: #f3f4f6; padding: 20px; border-radius: 10px; margin-top: 15px; display: none;">
                            <h4 style="color: #5830a3; margin-bottom: 10px;">Dream Analysis</h4>
                            <div id="analysisContent" style="color: #374151; line-height: 1.6;">Loading your dream interpretation...</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        async function analyzeDream() {
            const dreamText = document.getElementById('dreamText').value.trim();
            if (!dreamText) {
                alert('Please describe your dream first.');
                return;
            }
            
            const analysisDiv = document.getElementById('dreamAnalysis');
            const analysisContent = document.getElementById('analysisContent');
            
            analysisDiv.style.display = 'block';
            analysisContent.innerHTML = '<div style="text-align: center; color: #6366f1;"><div style="font-size: 2rem; margin-bottom: 10px;">🌙</div>Analyzing your dream through Maya wisdom...</div>';
            
            const token = localStorage.getItem('token');
            try {
                const response = await fetch('/api/dream-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        dream: dreamText,
                        userCosmicProfile: currentUserData
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    analysisContent.innerHTML = result.analysis;
                } else {
                    analysisContent.innerHTML = '<p style="color: #ef4444;">Unable to analyze dream. Please try again.</p>';
                }
            } catch (error) {
                console.error('Dream analysis error:', error);
                analysisContent.innerHTML = '<p style="color: #ef4444;">Network error. Please check your connection and try again.</p>';
            }
        }
        
        function closeDreamModal() {
            const modal = document.getElementById('dreamModal');
            if (modal) {
                modal.remove();
            }
        }
        
        function openSacredRituals() {
            if (!currentUser || !currentUser.id) {
                alert('Please log in to access Sacred Rituals.');
                return;
            }
            
            const modalHTML = `
                <div id="ritualsModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; display: flex; justify-content: center; align-items: center;">
                    <div style="background: white; padding: 30px; border-radius: 20px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <h2 style="color: #5830a3; font-size: 2rem; margin-bottom: 10px;">🌿 Sacred Rituals</h2>
                            <p style="color: #6366f1; font-size: 1.1rem;">Cosmic-aligned ceremonies and breathwork</p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div onclick="startBreathwork()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; cursor: pointer;">
                                <div style="font-size: 2rem; margin-bottom: 10px;">🌬️</div>
                                <h4>Breathwork Journey</h4>
                                <p style="font-size: 0.9rem; opacity: 0.9;">Element-based breathing patterns</p>
                            </div>
                            
                            <div onclick="getDailyRitual()" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; cursor: pointer;">
                                <div style="font-size: 2rem; margin-bottom: 10px;">🌟</div>
                                <h4>Daily Ritual</h4>
                                <p style="font-size: 0.9rem; opacity: 0.9;">Personalized ceremony for today</p>
                            </div>
                        </div>
                        
                        <div id="ritualContent" style="background: #f3f4f6; padding: 20px; border-radius: 10px; margin-bottom: 15px; display: none;">
                            <div id="ritualText">Select a ritual above to begin</div>
                        </div>
                        
                        <div style="text-align: center;">
                            <button onclick="closeRitualsModal()" style="background: #6b7280; color: white; padding: 12px 30px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer;">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }
        
        async function startBreathwork() {
            const ritualContent = document.getElementById('ritualContent');
            const ritualText = document.getElementById('ritualText');
            
            ritualContent.style.display = 'block';
            ritualText.innerHTML = '<div style="text-align: center; color: #6366f1;"><div style="font-size: 2rem; margin-bottom: 10px;">🌬️</div>Generating your personalized breathwork journey...</div>';
            
            const token = localStorage.getItem('token');
            try {
                const response = await fetch('/api/breathwork-ritual', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        userCosmicProfile: currentUserData
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    ritualText.innerHTML = result.ritual;
                } else {
                    ritualText.innerHTML = '<p style="color: #ef4444;">Unable to generate breathwork. Please try again.</p>';
                }
            } catch (error) {
                console.error('Breathwork error:', error);
                ritualText.innerHTML = '<p style="color: #ef4444;">Network error. Please check your connection and try again.</p>';
            }
        }
        
        async function getDailyRitual() {
            const ritualContent = document.getElementById('ritualContent');
            const ritualText = document.getElementById('ritualText');
            
            ritualContent.style.display = 'block';
            ritualText.innerHTML = '<div style="text-align: center; color: #6366f1;"><div style="font-size: 2rem; margin-bottom: 10px;">🌟</div>Creating your daily ritual...</div>';
            
            const token = localStorage.getItem('token');
            try {
                const response = await fetch('/api/daily-ritual', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        userCosmicProfile: currentUserData
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    ritualText.innerHTML = result.ritual;
                } else {
                    ritualText.innerHTML = '<p style="color: #ef4444;">Unable to generate daily ritual. Please try again.</p>';
                }
            } catch (error) {
                console.error('Daily ritual error:', error);
                ritualText.innerHTML = '<p style="color: #ef4444;">Network error. Please check your connection and try again.</p>';
            }
        }
        
        function closeRitualsModal() {
            const modal = document.getElementById('ritualsModal');
            if (modal) {
                modal.remove();
            }
        }
        
        function showComingSoon() {
            alert('Meditation Studio is coming soon! This feature will include guided meditations tuned to your galactic frequency and cosmic signature.');
        }

        // Premium Access Management
        let userAccess = null;

        async function loadUserAccess() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/user-access', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    userAccess = await response.json();
                    updateAccessDisplay();
                } else {
                    console.error('Failed to load user access');
                }
            } catch (error) {
                console.error('Access loading error:', error);
            }
        }

        function updateAccessDisplay() {
            const accessStatus = document.getElementById('accessStatus');
            if (!userAccess) {
                accessStatus.innerHTML = '<p style="color: #ef4444; font-size: 1.1rem; margin: 0;">Unable to load access status</p>';
                return;
            }

            if (userAccess.has_unlimited) {
                accessStatus.innerHTML = `
                    <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 15px; border-radius: 10px;">
                        <h4 style="margin: 0 0 5px 0; font-size: 1.1rem;">🌟 Unlimited Access Active</h4>
                        <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">You have full access to all spiritual tools and premium features</p>
                    </div>
                `;
            } else {
                const toolCount = userAccess.tools.length;
                accessStatus.innerHTML = `
                    <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 15px; border-radius: 10px;">
                        <h4 style="margin: 0 0 5px 0; font-size: 1.1rem;">💎 Premium Tools (${toolCount}/3 owned)</h4>
                        <p style="margin: 0; font-size: 0.9rem; opacity: 0.9;">Purchase individual tools or upgrade to unlimited access</p>
                    </div>
                `;
            }

            // Update tool cards with access status
            updateToolCardStatus();
        }

        function updateToolCardStatus() {
            const toolCards = document.querySelectorAll('.premium-tool-card');
            toolCards.forEach(card => {
                const toolName = card.getAttribute('data-tool');
                const statusElement = card.querySelector('.tool-status');
                
                if (userAccess.has_unlimited || userAccess.tools.includes(toolName) || userAccess.tools.includes('premium_bundle')) {
                    statusElement.textContent = '✅ Owned - Click to Use';
                    card.style.border = '2px solid #10b981';
                } else {
                    statusElement.textContent = '🔒 Click to Purchase';
                    card.style.border = '2px solid rgba(255,255,255,0.3)';
                }
            });
        }

        // Premium Gating for Spiritual Tools
        async function checkToolAccessAndProceed(toolName, callback) {
            if (!userAccess) {
                await loadUserAccess();
            }

            if (userAccess.has_unlimited || userAccess.tools.includes(toolName) || userAccess.tools.includes('premium_bundle')) {
                // User has access, proceed with tool
                callback();
            } else {
                // Show purchase modal
                showPurchaseModal(toolName);
            }
        }

        function showPurchaseModal(toolName) {
            const toolInfo = {
                'maya_oracle': { name: 'Maya Oracle Cards', price: '$9.97', description: 'Divine guidance through 20 sacred Maya cards with AI-powered ancestral wisdom' },
                'dream_interpreter': { name: 'Dream Interpreter', price: '$14.97', description: 'AI-powered dream analysis with Maya symbolism and personal cosmic integration' },
                'sacred_rituals': { name: 'Sacred Rituals', price: '$19.97', description: 'Personalized breathwork, ceremonies, and cosmic-aligned daily spiritual practices' }
            };

            const tool = toolInfo[toolName];
            const modalHTML = `
                <div id="purchaseModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; display: flex; justify-content: center; align-items: center;">
                    <div style="background: white; padding: 40px; border-radius: 20px; max-width: 600px; width: 90%; text-align: center;">
                        <h2 style="color: #5830a3; font-size: 2rem; margin-bottom: 20px;">${tool.name}</h2>
                        <p style="color: #6366f1; font-size: 1.1rem; margin-bottom: 20px;">${tool.description}</p>
                        
                        <div style="background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                            <div style="font-size: 2rem; margin-bottom: 10px; color: #5830a3;">${tool.price}</div>
                            <p style="color: #374151; margin: 0;">One-time purchase - lifetime access</p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <button onclick="purchaseIndividualTool('${toolName}')" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 15px 20px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer;">
                                Buy Now ${tool.price}
                            </button>
                            <button onclick="showPremiumBundle()" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 15px 20px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer;">
                                Bundle $29.97 (Save!)
                            </button>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <button onclick="purchaseSubscription('monthly_unlimited')" style="background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%); color: white; padding: 12px 25px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-right: 10px;">
                                Unlimited $49.97/mo
                            </button>
                            <button onclick="purchaseSubscription('annual_unlimited')" style="background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; padding: 12px 25px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">
                                Annual $299.97 (Best Deal!)
                            </button>
                        </div>
                        
                        <button onclick="closePurchaseModal()" style="background: #6b7280; color: white; padding: 10px 20px; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer;">
                            Maybe Later
                        </button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closePurchaseModal() {
            const modal = document.getElementById('purchaseModal');
            if (modal) modal.remove();
        }

        // Stripe Payment Integration
        async function purchaseIndividualTool(toolName) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/create-payment-intent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ tool_name: toolName })
                });

                if (response.ok) {
                    const result = await response.json();
                    await processStripePayment(result.client_secret, toolName);
                } else {
                    alert('Payment setup failed. Please try again.');
                }
            } catch (error) {
                console.error('Payment error:', error);
                alert('Payment error. Please check your connection and try again.');
            }
        }

        function showPremiumBundle() {
            closePurchaseModal();
            const modalHTML = `
                <div id="bundleModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; display: flex; justify-content: center; align-items: center;">
                    <div style="background: white; padding: 40px; border-radius: 20px; max-width: 700px; width: 90%; text-align: center;">
                        <h2 style="color: #5830a3; font-size: 2.5rem; margin-bottom: 20px;">💎 Premium Bundle</h2>
                        <p style="color: #6366f1; font-size: 1.2rem; margin-bottom: 30px;">All 3 spiritual tools with exclusive bonuses</p>
                        
                        <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px;">
                            <div style="font-size: 3rem; margin-bottom: 15px;">$29.97</div>
                            <div style="font-size: 1.2rem; margin-bottom: 10px;">Save $14.94 vs individual purchase</div>
                            <p style="margin: 0; opacity: 0.9;">Maya Oracle Cards + Dream Interpreter + Sacred Rituals</p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <button onclick="purchaseIndividualTool('premium_bundle')" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 15px 20px; border: none; border-radius: 10px; font-size: 1.2rem; font-weight: 600; cursor: pointer;">
                                Buy Bundle $29.97
                            </button>
                            <button onclick="closeBundleModal()" style="background: #6b7280; color: white; padding: 15px 20px; border: none; border-radius: 10px; font-size: 1.2rem; font-weight: 600; cursor: pointer;">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeBundleModal() {
            const modal = document.getElementById('bundleModal');
            if (modal) modal.remove();
        }

        async function purchaseSubscription(planType) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/create-subscription', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ plan_type: planType })
                });

                if (response.ok) {
                    const result = await response.json();
                    await processStripePayment(result.client_secret, planType);
                } else {
                    alert('Subscription setup failed. Please try again.');
                }
            } catch (error) {
                console.error('Subscription error:', error);
                alert('Subscription error. Please check your connection and try again.');
            }
        }

        async function processStripePayment(clientSecret, itemName) {
            // Create a simple payment form
            const paymentHTML = `
                <div id="paymentModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 15000; display: flex; justify-content: center; align-items: center;">
                    <div style="background: white; padding: 40px; border-radius: 20px; max-width: 500px; width: 90%; text-align: center;">
                        <h3 style="color: #5830a3; margin-bottom: 20px;">Complete Your Purchase</h3>
                        <p style="color: #6366f1; margin-bottom: 30px;">Secure payment processing</p>
                        
                        <div style="background: #f3f4f6; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <p style="color: #374151; margin: 0;">
                                💳 Payment processing will be completed with Stripe.<br>
                                Your spiritual tools will be activated immediately after payment.
                            </p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <button onclick="simulatePaymentSuccess('${itemName}')" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 15px 20px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer;">
                                Complete Payment
                            </button>
                            <button onclick="closePaymentModal()" style="background: #6b7280; color: white; padding: 15px 20px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer;">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', paymentHTML);
        }

        function closePaymentModal() {
            const modal = document.getElementById('paymentModal');
            if (modal) modal.remove();
        }

        // Simulate successful payment for demo (replace with real Stripe integration)
        async function simulatePaymentSuccess(itemName) {
            closePaymentModal();
            closePurchaseModal();
            closeBundleModal();
            
            // Show success message
            const successHTML = `
                <div id="successModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; display: flex; justify-content: center; align-items: center;">
                    <div style="background: white; padding: 40px; border-radius: 20px; max-width: 500px; width: 90%; text-align: center;">
                        <div style="font-size: 4rem; color: #10b981; margin-bottom: 20px;">✅</div>
                        <h3 style="color: #5830a3; margin-bottom: 15px;">Payment Successful!</h3>
                        <p style="color: #6366f1; margin-bottom: 25px;">Your spiritual tools have been activated.</p>
                        <button onclick="closeSuccessModal(); loadUserAccess();" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 15px 30px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer;">
                            Start Using Tools
                        </button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', successHTML);
        }

        function closeSuccessModal() {
            const modal = document.getElementById('successModal');
            if (modal) modal.remove();
        }

        // Update spiritual tool functions to use premium gating
        function openMayaOracle() {
            checkToolAccessAndProceed('maya_oracle', () => {
                // Original Maya Oracle function code here
                if (!currentUser || !currentUser.id) {
                    alert('Please log in to access the Maya Oracle Cards.');
                    return;
                }
                
                // Create and show Maya Oracle modal (keeping existing code)
                const modalHTML = `
                    <div id="oracleModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; display: flex; justify-content: center; align-items: center;">
                        <div style="background: white; padding: 30px; border-radius: 20px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <h2 style="color: #5830a3; font-size: 2rem; margin-bottom: 10px;">🔮 Maya Oracle Cards</h2>
                                <p style="color: #6366f1; font-size: 1.1rem;">Ancient wisdom channeled through sacred cards</p>
                            </div>
                            
                            <div style="text-align: center; margin-bottom: 20px;">
                                <div id="oracleCard" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 30px; border-radius: 15px; margin-bottom: 15px; min-height: 200px; display: flex; flex-direction: column; justify-content: center;">
                                    <div style="font-size: 3rem; margin-bottom: 10px;">🔮</div>
                                    <h3 id="cardTitle" style="font-size: 1.5rem; margin-bottom: 10px;">Click "Draw Card" to begin</h3>
                                    <p id="cardMessage" style="font-size: 1rem; opacity: 0.9;">Focus on your question and draw your sacred card</p>
                                </div>
                                
                                <button onclick="drawOracleCard()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 12px 30px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer; margin-right: 10px;">
                                    Draw Card
                                </button>
                                <button onclick="closeOracleModal()" style="background: #6b7280; color: white; padding: 12px 30px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer;">
                                    Close
                                </button>
                            </div>
                            
                            <div id="oracleInterpretation" style="background: #f3f4f6; padding: 20px; border-radius: 10px; margin-top: 15px; display: none;">
                                <h4 style="color: #5830a3; margin-bottom: 10px;">Personalized Interpretation</h4>
                                <p id="interpretationText" style="color: #374151; line-height: 1.6;">Loading your personalized guidance...</p>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            });
        }

        function openDreamInterpreter() {
            checkToolAccessAndProceed('dream_interpreter', () => {
                if (!currentUser || !currentUser.id) {
                    alert('Please log in to access the Dream Interpreter.');
                    return;
                }
                
                const modalHTML = `
                    <div id="dreamModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; display: flex; justify-content: center; align-items: center;">
                        <div style="background: white; padding: 30px; border-radius: 20px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <h2 style="color: #5830a3; font-size: 2rem; margin-bottom: 10px;">🌙 Dream Interpreter</h2>
                                <p style="color: #6366f1; font-size: 1.1rem;">AI-powered dream analysis with Maya symbolism</p>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Describe your dream:</label>
                                <textarea id="dreamText" style="width: 100%; height: 120px; padding: 10px; border: 2px solid #d1d5db; border-radius: 8px; font-family: inherit; resize: vertical;" placeholder="Share your dream in detail - include emotions, symbols, colors, people, and any significant moments..."></textarea>
                            </div>
                            
                            <div style="text-align: center; margin-bottom: 20px;">
                                <button onclick="analyzeDream()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 12px 30px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer; margin-right: 10px;">
                                    Analyze Dream
                                </button>
                                <button onclick="closeDreamModal()" style="background: #6b7280; color: white; padding: 12px 30px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer;">
                                    Close
                                </button>
                            </div>
                            
                            <div id="dreamAnalysis" style="background: #f3f4f6; padding: 20px; border-radius: 10px; margin-top: 15px; display: none;">
                                <h4 style="color: #5830a3; margin-bottom: 10px;">Dream Analysis</h4>
                                <div id="analysisContent" style="color: #374151; line-height: 1.6;">Loading your dream interpretation...</div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            });
        }

        function openSacredRituals() {
            checkToolAccessAndProceed('sacred_rituals', () => {
                if (!currentUser || !currentUser.id) {
                    alert('Please log in to access Sacred Rituals.');
                    return;
                }
                
                const modalHTML = `
                    <div id="ritualsModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; display: flex; justify-content: center; align-items: center;">
                        <div style="background: white; padding: 30px; border-radius: 20px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <h2 style="color: #5830a3; font-size: 2rem; margin-bottom: 10px;">🌿 Sacred Rituals</h2>
                                <p style="color: #6366f1; font-size: 1.1rem;">Cosmic-aligned ceremonies and breathwork</p>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                <div onclick="startBreathwork()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; cursor: pointer;">
                                    <div style="font-size: 2rem; margin-bottom: 10px;">🌬️</div>
                                    <h4>Breathwork Journey</h4>
                                    <p style="font-size: 0.9rem; opacity: 0.9;">Element-based breathing patterns</p>
                                </div>
                                
                                <div onclick="getDailyRitual()" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; cursor: pointer;">
                                    <div style="font-size: 2rem; margin-bottom: 10px;">🌟</div>
                                    <h4>Daily Ritual</h4>
                                    <p style="font-size: 0.9rem; opacity: 0.9;">Personalized ceremony for today</p>
                                </div>
                            </div>
                            
                            <div id="ritualContent" style="background: #f3f4f6; padding: 20px; border-radius: 10px; margin-bottom: 15px; display: none;">
                                <div id="ritualText">Select a ritual above to begin</div>
                            </div>
                            
                            <div style="text-align: center;">
                                <button onclick="closeRitualsModal()" style="background: #6b7280; color: white; padding: 12px 30px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer;">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            });
        }

        // Download soul contract
        async function downloadSoulContract() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/download-soul-contract', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to download soul contract');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `soul-contract-${currentUserData?.first_name || 'sacred-soul'}.html`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                
            } catch (error) {
                console.error('Error downloading soul contract:', error);
                alert('Error downloading soul contract. Please try again.');
            }
        }

        // Share soul contract
        async function shareSoulContract() {
            try {
                const shareData = {
                    title: 'My Sacred Soul Contract',
                    text: `I just received my personalized sacred soul contract that reveals my soul origins, sacred gifts, and destiny mission! This ancient Maya wisdom has provided deep insights into my spiritual journey. Discover your own magic at The Magic is You!`,
                    url: window.location.href
                };

                if (navigator.share) {
                    await navigator.share(shareData);
                } else {
                    // Fallback for browsers that don't support Web Share API
                    const shareText = `${shareData.text} ${shareData.url}`;
                    await navigator.clipboard.writeText(shareText);
                    alert('Soul contract sharing text copied to clipboard!');
                }
            } catch (error) {
                console.error('Error sharing soul contract:', error);
                alert('Error sharing soul contract. Please try again.');
            }
        }

        async function shareCosmicElement(elementName, elementValue) {
            try {
                const shareData = {
                    title: `My ${elementName} Cosmic Element`,
                    text: `I just discovered my ${elementName} is ${elementValue}! This personalized Maya cosmic element reveals deep insights about my spiritual journey. Discover your own cosmic elements at The Magic is You!`,
                    url: window.location.href
                };

                if (navigator.share) {
                    await navigator.share(shareData);
                } else {
                    // Fallback for browsers that don't support Web Share API
                    const shareText = `${shareData.text} ${shareData.url}`;
                    await navigator.clipboard.writeText(shareText);
                    alert('Cosmic element sharing text copied to clipboard!');
                }
            } catch (error) {
                console.error('Error sharing cosmic element:', error);
                alert('Error sharing cosmic element. Please try again.');
            }
        }

        async function shareGuidanceContent(guidanceText, mayaDay, lunarPhase) {
            try {
                const shareData = {
                    title: 'My Spiritual Guidance',
                    text: `I just received personalized spiritual guidance from The Magic is You! During ${mayaDay} energy with ${lunarPhase}, I was guided: "${guidanceText.substring(0, 100)}..." This ancient Maya wisdom provided exactly what I needed. Discover your own spiritual guidance at magic.mayanbelize.com!`,
                    url: 'https://magic.mayanbelize.com'
                };

                if (navigator.share) {
                    await navigator.share(shareData);
                } else {
                    // Fallback for browsers that don't support Web Share API
                    const shareText = `${shareData.text} ${shareData.url}`;
                    await navigator.clipboard.writeText(shareText);
                    alert('Spiritual guidance sharing text copied to clipboard!');
                }
            } catch (error) {
                console.error('Error sharing spiritual guidance:', error);
                alert('Error sharing spiritual guidance. Please try again.');
            }
        }

        // View spiritual patterns
        async function viewSpiritualPatterns() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/spiritual-patterns', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load patterns');
                }

                const patterns = await response.json();
                
                // Show in modal
                const modal = document.getElementById('elementModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalBody = document.getElementById('modalBody');
                
                modalTitle.textContent = '🌟 Your Spiritual Patterns';
                modalBody.innerHTML = `
                    <div style="line-height: 1.6; color: #1e3a8a;">
                        <h3>📊 Engagement Overview</h3>
                        <p><strong>Total Interactions:</strong> ${patterns.total_interactions || 0}</p>
                        <p><strong>Engagement Trend:</strong> ${patterns.engagement_trend || 'New user'}</p>
                        <p><strong>Average Engagement:</strong> ${patterns.avg_engagement || 'N/A'}</p>
                        
                        <h3>🎯 Preferred Elements</h3>
                        <p>${patterns.preferred_elements?.join(', ') || 'Still discovering your preferences'}</p>
                        
                        <h3>🌿 Spiritual Focus Areas</h3>
                        <p>${patterns.spiritual_focus_areas?.join(', ') || 'Exploring all areas'}</p>
                        
                        <h3>💡 Recommended Next Steps</h3>
                        <ul>
                            ${patterns.recommended_next_steps?.map(step => `<li>${step}</li>`).join('') || '<li>Continue exploring your cosmic elements</li>'}
                        </ul>
                    </div>
                `;
                modal.style.display = 'block';
                
            } catch (error) {
                console.error('Error loading patterns:', error);
                alert('Error loading spiritual patterns. Please try again.');
            }
        }

        // Floating Chat Functions
        let isRecording = false;
        let recognition = null;
        let currentLanguage = 'english';

        // Initialize Speech Recognition
        function initializeSpeechRecognition() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = currentLanguage === 'spanish' ? 'es-ES' : 'en-US';
                
                recognition.onresult = function(event) {
                    const text = event.results[0][0].transcript;
                    document.getElementById('chatInput').value = text;
                    sendChatMessage();
                };
                
                recognition.onerror = function() {
                    toggleVoiceInput(); // Stop recording on error
                };
            }
        }

        // Open floating chat
        function openFloatingChat() {
            const overlay = document.getElementById('chatPopupOverlay');
            overlay.style.display = 'flex';
            document.getElementById('chatInput').focus();
            
            // Initialize speech recognition if not already done
            if (!recognition) {
                initializeSpeechRecognition();
            }
        }

        // Close floating chat
        function closeFloatingChat() {
            const overlay = document.getElementById('chatPopupOverlay');
            overlay.style.display = 'none';
            
            // Stop voice recording if active
            if (isRecording) {
                toggleVoiceInput();
            }
        }

        // Toggle voice input
        function toggleVoiceInput() {
            const voiceBtn = document.getElementById('voiceBtn');
            
            if (!recognition) {
                alert('Voice recognition is not supported in this browser.');
                return;
            }
            
            if (isRecording) {
                recognition.stop();
                voiceBtn.classList.remove('recording');
                voiceBtn.textContent = '🎤';
                isRecording = false;
            } else {
                recognition.lang = currentLanguage === 'spanish' ? 'es-ES' : 'en-US';
                recognition.start();
                voiceBtn.classList.add('recording');
                voiceBtn.textContent = '🔴';
                isRecording = true;
            }
        }

        // Handle chat input key press
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendChatMessage();
            }
        }

        // Send chat message
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const sendBtn = document.getElementById('chatSendBtn');
            const messages = document.getElementById('chatMessages');
            const language = document.getElementById('chatLanguage').value;
            
            const message = input.value.trim();
            if (!message) return;
            
            // Add user message
            const userMessage = document.createElement('div');
            userMessage.className = 'chat-message user';
            userMessage.innerHTML = `<strong>You:</strong> ${message}`;
            messages.appendChild(userMessage);
            
            // Clear input and disable send button
            input.value = '';
            sendBtn.disabled = true;
            sendBtn.textContent = 'Sending...';
            
            // Add loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'chat-loading';
            loadingDiv.innerHTML = 'Ix Chel is responding';
            messages.appendChild(loadingDiv);
            
            // Scroll to bottom
            messages.scrollTop = messages.scrollHeight;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/ix-chel-chat', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        message: message,
                        language: language 
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to connect to Ix Chel');
                }

                const data = await response.json();
                
                // Remove loading indicator
                messages.removeChild(loadingDiv);
                
                // Add AI response
                const aiMessage = document.createElement('div');
                aiMessage.className = 'chat-message ai';
                aiMessage.innerHTML = `<strong>Ix Chel:</strong> ${data.response}`;
                messages.appendChild(aiMessage);
                
                // Scroll to bottom
                messages.scrollTop = messages.scrollHeight;
                
            } catch (error) {
                console.error('Error connecting to Ix Chel:', error);
                
                // Remove loading indicator
                if (messages.contains(loadingDiv)) {
                    messages.removeChild(loadingDiv);
                }
                
                // Add error message
                const errorMessage = document.createElement('div');
                errorMessage.className = 'chat-message ai';
                errorMessage.innerHTML = `<strong>Ix Chel:</strong> In Lak'ech, sacred soul. The cosmic currents are strong right now. Please try again in a moment.`;
                messages.appendChild(errorMessage);
                
                messages.scrollTop = messages.scrollHeight;
            } finally {
                // Re-enable send button
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send';
                input.focus();
            }
        }

        // Language change handler
        document.addEventListener('DOMContentLoaded', function() {
            const languageSelector = document.getElementById('chatLanguage');
            if (languageSelector) {
                languageSelector.addEventListener('change', function() {
                    currentLanguage = this.value;
                    if (recognition) {
                        recognition.lang = currentLanguage === 'spanish' ? 'es-ES' : 'en-US';
                    }
                });
            }
        });

        // Track interaction completion
        function trackInteractionCompletion(elementType, engagementLevel) {
            if (interactionStartTime) {
                const timeSpent = (Date.now() - interactionStartTime) / 1000;
                
                fetch('/api/track-user-interaction', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        interaction_type: 'element_exploration',
                        element_accessed: elementType,
                        time_spent: timeSpent,
                        engagement_level: engagementLevel || 5
                    })
                }).catch(error => console.error('Error tracking interaction:', error));
                
                interactionStartTime = null;
            }
        }



        // Logout function
        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/';
        }
        
        // Show coming soon modal for future features
        function showComingSoon(feature) {
            const modal = document.getElementById('elementModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = `🚀 ${feature} Coming Soon!`;
            modalBody.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <h3 style="color: #5830a3; margin-bottom: 1rem;">✨ ${feature} Section in Development</h3>
                    <p style="font-size: 1.1rem; line-height: 1.6; color: #1e3a8a; margin-bottom: 1.5rem;">
                        We're working on bringing you an amazing ${feature.toLowerCase()} experience! 
                        ${feature === 'Shop' ? 'Sacred merchandise, crystals, and spiritual tools' : 'Transformative retreats and spiritual events'} 
                        will be available soon.
                    </p>
                    <div style="margin-top: 1.5rem;">
                        <a href="https://MayanBelize.com" target="_blank" style="
                            display: inline-block;
                            background: linear-gradient(135deg, #10b981, #059669);
                            color: white;
                            padding: 0.75rem 1.5rem;
                            border-radius: 0.5rem;
                            text-decoration: none;
                            font-weight: 600;
                        ">🌎 Visit MayanBelize.com</a>
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
        }
        
        // Show subscription options modal
        function showSubscriptionOptions() {
            const modal = document.getElementById('elementModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = '💎 Spiritual Tools Premium';
            modalBody.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <h2 style="color: #5830a3; margin-bottom: 20px;">Choose Your Spiritual Journey</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; padding: 20px; border-radius: 15px; text-align: center;">
                            <h3 style="font-size: 1.2rem; margin-bottom: 10px;">Monthly</h3>
                            <div style="font-size: 2rem; font-weight: bold; margin-bottom: 10px;">$11</div>
                            <p style="font-size: 0.9rem; opacity: 0.9;">per month</p>
                            <button style="background: white; color: #6366f1; padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 10px;" onclick="startSubscription('monthly')">Choose Monthly</button>
                        </div>
                        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px; border-radius: 15px; text-align: center; position: relative;">
                            <div style="position: absolute; top: -10px; right: -10px; background: #f59e0b; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: 600;">Save $21</div>
                            <h3 style="font-size: 1.2rem; margin-bottom: 10px;">Annual</h3>
                            <div style="font-size: 2rem; font-weight: bold; margin-bottom: 10px;">$111</div>
                            <p style="font-size: 0.9rem; opacity: 0.9;">per year</p>
                            <button style="background: white; color: #10b981; padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 10px;" onclick="startSubscription('annual')">Choose Annual</button>
                        </div>
                    </div>
                    <div style="background: #f0f9ff; padding: 15px; border-radius: 10px; margin-top: 20px;">
                        <h4 style="color: #0369a1; margin-bottom: 10px;">Subscription includes:</h4>
                        <ul style="text-align: left; color: #0369a1; line-height: 1.6;">
                            <li>Maya Oracle Cards with AI wisdom</li>
                            <li>Dream Interpreter with Maya symbolism</li>
                            <li>Sacred Rituals & Breathwork ceremonies</li>
                            <li>Personalized cosmic guidance</li>
                            <li>Unlimited tool usage</li>
                            <li>Priority customer support</li>
                        </ul>
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        // Start subscription process
        function startSubscription(planType) {
            const plan = planType === 'monthly' ? 'monthly_subscription' : 'annual_subscription';
            
            // Create subscription with Stripe
            fetch('/api/create-subscription', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify({
                    plan_type: plan
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    showModal('Subscription Created', 'Your subscription has been created! You now have access to all spiritual tools.', 'success');
                } else {
                    showModal('Error', 'Unable to start subscription. Please try again.', 'error');
                }
            })
            .catch(error => {
                console.error('Subscription error:', error);
                showModal('Error', 'Unable to start subscription. Please try again.', 'error');
            });
        }

        // Check promotional status and update pricing
        async function checkPromotionalStatus() {
            try {
                const response = await fetch('/api/get-pricing');
                const data = await response.json();
                
                if (data.promo_active) {
                    // Show promotional banner
                    const promoBanner = document.getElementById('promoBanner');
                    if (promoBanner) {
                        promoBanner.style.display = 'block';
                    }
                    
                    // Update all pricing displays to show promotional status
                    updatePricingDisplay(data);
                } else {
                    // Hide promotional banner
                    const promoBanner = document.getElementById('promoBanner');
                    if (promoBanner) {
                        promoBanner.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error checking promotional status:', error);
            }
        }
        
        function updatePricingDisplay(pricingData) {
            // Update spiritual tools pricing display
            const toolCards = document.querySelectorAll('.spiritual-tool-card');
            toolCards.forEach(card => {
                const priceElement = card.querySelector('.tool-price');
                if (priceElement && pricingData.promo_active) {
                    priceElement.innerHTML = `
                        <div style="color: #059669; font-weight: bold; font-size: 1.1rem;">
                            Coming Soon in Development
                        </div>
                        <div style="color: #6b7280; font-size: 0.9rem; text-decoration: line-through;">
                            ${priceElement.getAttribute('data-original-price') || 'Premium'}
                        </div>
                    `;
                }
            });
        }

        // Close functions for modals
        function closeOracleModal() {
            const modal = document.getElementById('oracleModal');
            if (modal) modal.remove();
        }

        function closeDreamModal() {
            const modal = document.getElementById('dreamModal');
            if (modal) modal.remove();
        }

        function closeRitualsModal() {
            const modal = document.getElementById('ritualsModal');
            if (modal) modal.remove();
        }

        // Spiritual tool functions
        async function drawOracleCard() {
            const cardTitle = document.getElementById('cardTitle');
            const cardMessage = document.getElementById('cardMessage');
            const interpretationDiv = document.getElementById('oracleInterpretation');
            const interpretationText = document.getElementById('interpretationText');
            
            // Show drawing animation
            cardTitle.textContent = 'Drawing your sacred card...';
            cardMessage.textContent = 'The ancestors are speaking...';
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/oracle-interpretation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ question: 'Please provide guidance for my spiritual journey' })
                });

                if (response.ok) {
                    const result = await response.json();
                    cardTitle.textContent = 'Your Sacred Card';
                    cardMessage.textContent = 'Ancient wisdom reveals itself';
                    interpretationDiv.style.display = 'block';
                    interpretationText.innerHTML = result.interpretation || 'The wisdom of the ancestors flows through you.';
                } else {
                    const errorData = await response.json();
                    if (errorData.premium_required) {
                        closeOracleModal();
                        showPurchaseModal(errorData.tool_name);
                    } else {
                        cardTitle.textContent = 'Connection Lost';
                        cardMessage.textContent = 'Please try again later';
                    }
                }
            } catch (error) {
                console.error('Oracle error:', error);
                cardTitle.textContent = 'Spiritual Guidance';
                cardMessage.textContent = 'Trust your inner wisdom';
            }
        }

        async function analyzeDream() {
            const dreamText = document.getElementById('dreamText').value.trim();
            if (!dreamText) {
                alert('Please describe your dream first');
                return;
            }

            const analysisDiv = document.getElementById('dreamAnalysis');
            const analysisContent = document.getElementById('analysisContent');
            
            analysisDiv.style.display = 'block';
            analysisContent.innerHTML = '<div style="text-align: center;"><div style="display: inline-block; width: 20px; height: 20px; border: 2px solid #5830a3; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div><p>Analyzing your dream with Maya wisdom...</p></div>';

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/dream-analysis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ dream_description: dreamText })
                });

                if (response.ok) {
                    const result = await response.json();
                    analysisContent.innerHTML = result.analysis || 'Your dream carries profound spiritual meaning.';
                } else {
                    const errorData = await response.json();
                    if (errorData.premium_required) {
                        closeDreamModal();
                        showPurchaseModal(errorData.tool_name);
                    } else {
                        analysisContent.innerHTML = 'Unable to analyze dream at this time. Trust your intuition.';
                    }
                }
            } catch (error) {
                console.error('Dream analysis error:', error);
                analysisContent.innerHTML = 'Your dreams are a sacred gateway to wisdom.';
            }
        }

        async function startBreathwork() {
            const ritualContent = document.getElementById('ritualContent');
            const ritualText = document.getElementById('ritualText');
            
            ritualContent.style.display = 'block';
            ritualText.innerHTML = '<div style="text-align: center;"><div style="display: inline-block; width: 20px; height: 20px; border: 2px solid #10b981; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div><p>Creating your personalized breathwork journey...</p></div>';

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/breathwork-ritual', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ ritual_type: 'breathwork' })
                });

                if (response.ok) {
                    const result = await response.json();
                    ritualText.innerHTML = result.ritual || 'Breathe with the rhythm of the cosmos.';
                } else {
                    const errorData = await response.json();
                    if (errorData.premium_required) {
                        closeRitualsModal();
                        showPurchaseModal(errorData.tool_name);
                    } else {
                        ritualText.innerHTML = 'Connect with your breath and feel the sacred energy within.';
                    }
                }
            } catch (error) {
                console.error('Breathwork error:', error);
                ritualText.innerHTML = 'Your breath is your connection to universal life force.';
            }
        }

        async function getDailyRitual() {
            const ritualContent = document.getElementById('ritualContent');
            const ritualText = document.getElementById('ritualText');
            
            ritualContent.style.display = 'block';
            ritualText.innerHTML = '<div style="text-align: center;"><div style="display: inline-block; width: 20px; height: 20px; border: 2px solid #8b5cf6; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div><p>Crafting your sacred daily ritual...</p></div>';

            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/daily-ritual', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ ritual_type: 'daily' })
                });

                if (response.ok) {
                    const result = await response.json();
                    ritualText.innerHTML = result.ritual || 'Begin each day with sacred intention.';
                } else {
                    const errorData = await response.json();
                    if (errorData.premium_required) {
                        closeRitualsModal();
                        showPurchaseModal(errorData.tool_name);
                    } else {
                        ritualText.innerHTML = 'Start your day with gratitude and cosmic awareness.';
                    }
                }
            } catch (error) {
                console.error('Daily ritual error:', error);
                ritualText.innerHTML = 'Your daily practice connects you to divine energy.';
            }
        }

        // Modal event handlers
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('elementModal');
            const closeButton = document.querySelector('.close');
            
            closeButton.onclick = function() {
                modal.style.display = 'none';
                trackInteractionCompletion('modal_close', 6);
            };
            
            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = 'none';
                    trackInteractionCompletion('modal_close', 4);
                }
            };
            
            // Load user access on page load
            loadUserData();
            loadUserAccess();
            
            // Check promotional status
            checkPromotionalStatus();
        });

        // Phase 3 Enhanced Personalization Functions
        // ================================================

        // Format Daily Insight for Better Visual Appeal
        function formatDailyInsight(insightText) {
            if (!insightText) return '<p>Loading personalized insight...</p>';
            
            // Split text into paragraphs and format
            const paragraphs = insightText.split('\n\n').filter(p => p.trim());
            
            let formattedHtml = '';
            
            paragraphs.forEach((paragraph, index) => {
                const trimmedParagraph = paragraph.trim();
                
                // Check if paragraph contains a title/heading (starts with ** or has specific keywords)
                if (trimmedParagraph.match(/^\*\*.*\*\*/) || 
                    trimmedParagraph.includes('Today\'s Energy') || 
                    trimmedParagraph.includes('Cosmic Guidance') ||
                    trimmedParagraph.includes('Sacred Message') ||
                    trimmedParagraph.includes('Divine Insight')) {
                    
                    // Format as heading
                    const cleanTitle = trimmedParagraph.replace(/\*\*/g, '').trim();
                    formattedHtml += `<h4 style="color: #8b4513; font-weight: 600; margin-bottom: 0.75rem; margin-top: ${index > 0 ? '1.5rem' : '0'}; font-size: 1.1rem;">${cleanTitle}</h4>`;
                    
                } else if (trimmedParagraph.length > 0) {
                    // Format as paragraph with better spacing
                    formattedHtml += `<p style="margin-bottom: 1rem; line-height: 1.6; color: #374151;">${trimmedParagraph}</p>`;
                }
            });
            
            // If no formatted content, return original as single paragraph
            if (!formattedHtml) {
                formattedHtml = `<p style="margin-bottom: 1rem; line-height: 1.6; color: #374151;">${insightText}</p>`;
            }
            
            return formattedHtml;
        }

        // Load Daily Spiritual Insights
        async function loadDailyInsights() {
            try {
                const response = await fetch('/api/daily-spiritual-insights', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const insights = await response.json();
                    
                    // Format and display daily insight with better visual structure
                    const formattedInsight = formatDailyInsight(insights.daily_insight);
                    document.getElementById('daily-insight').innerHTML = formattedInsight;
                    
                    // Show cosmic energy info
                    const cosmicInfo = insights.cosmic_energy;
                    document.getElementById('maya-day').textContent = cosmicInfo.maya_day;
                    document.getElementById('lunar-phase').textContent = cosmicInfo.lunar_phase;
                    document.getElementById('energy-level').textContent = 
                        (cosmicInfo.overall_intensity * 100).toFixed(1) + '%';
                    
                    // Display recommended practices with better formatting
                    const practicesList = document.getElementById('recommended-practices');
                    practicesList.innerHTML = '';
                    
                    // Add section header for practices
                    const practicesHeader = document.createElement('h4');
                    practicesHeader.style.cssText = 'color: #8b4513; font-weight: 600; margin-bottom: 1rem; font-size: 1.1rem;';
                    practicesHeader.textContent = 'Recommended Spiritual Practices';
                    practicesList.appendChild(practicesHeader);
                    
                    insights.recommended_practices.forEach(practice => {
                        const li = document.createElement('li');
                        li.style.cssText = 'margin-bottom: 0.75rem; padding: 0.5rem; background: rgba(139, 69, 19, 0.05); border-radius: 0.5rem; border-left: 3px solid #8b4513; line-height: 1.5; color: #374151;';
                        li.textContent = practice;
                        practicesList.appendChild(li);
                    });
                } else {
                    console.error('Failed to load daily insights');
                    document.getElementById('daily-insight').innerHTML = 
                        '<p>Unable to load daily insights. Please try again later.</p>';
                }
            } catch (error) {
                console.error('Error loading daily insights:', error);
                document.getElementById('daily-insight').innerHTML = 
                    '<p>Error loading insights. Please refresh the page.</p>';
            }
        }

        // Request Spiritual Guidance
        async function requestGuidance() {
            const urgency = document.getElementById('guidance-urgency').value;
            const theme = document.getElementById('guidance-theme').value;
            const situation = document.getElementById('current-situation').value;
            
            if (!situation.trim()) {
                alert('Please describe your current situation or question.');
                return;
            }
            
            // Show loading state
            const responseDiv = document.getElementById('guidance-response');
            responseDiv.style.display = 'block';
            responseDiv.innerHTML = `
                <div class="loading-indicator">
                    <div class="loading-spinner"></div>
                    Receiving spiritual guidance...
                </div>
            `;
            
            try {
                const response = await fetch('/api/dynamic-spiritual-guidance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        urgency: urgency,
                        theme: theme,
                        current_situation: situation,
                        specific_question: situation,
                        emotional_state: "seeking guidance"
                    })
                });
                
                if (response.ok) {
                    const guidance = await response.json();
                    
                    responseDiv.innerHTML = `
                        <h4>Your Spiritual Guidance</h4>
                        <p><strong>Guidance:</strong> ${guidance.guidance}</p>
                        <p><strong>Confidence:</strong> ${(guidance.confidence_score * 100).toFixed(1)}%</p>
                        <p><strong>Cosmic Energy:</strong> ${guidance.cosmic_energy.maya_day} - ${guidance.cosmic_energy.lunar_phase}</p>
                        <div style="margin-top: 1rem;">
                            <h5>Recommended Practices:</h5>
                            <ul>
                                ${guidance.recommended_practices.map(practice => `<li>${practice}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                    
                    // Track interaction
                    trackGuidanceInteraction(theme, urgency, guidance.confidence_score);
                    
                } else {
                    responseDiv.innerHTML = '<p>Unable to receive guidance at this time. Please try again.</p>';
                }
            } catch (error) {
                console.error('Error requesting guidance:', error);
                responseDiv.innerHTML = '<p>Error receiving guidance. Please try again.</p>';
            }
        }



        // Track Guidance Interaction
        function trackGuidanceInteraction(theme, urgency, confidence) {
            fetch('/api/spiritual-feedback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify({
                    content_type: 'spiritual_guidance',
                    rating: 5,
                    emotional_response: 'guided',
                    engagement_level: urgency === 'critical' ? 5 : urgency === 'high' ? 4 : 3,
                    time_spent: 60.0,
                    element_focused: theme
                })
            });
        }

        // Daily Insights Modal Function
        async function showDailyInsights() {
            const modal = document.getElementById('elementModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = '🌅 Your Daily Spiritual Insights';
            modalBody.innerHTML = '<div class="loading-indicator"><div class="loading-spinner"></div>Loading your daily insights...</div>';
            modal.style.display = 'block';
            
            try {
                const response = await fetch('/api/daily-spiritual-insights', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (response.ok) {
                    const insights = await response.json();
                    modalBody.innerHTML = `
                        <div style="line-height: 1.6; color: #1e3a8a;">
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #8b4513; margin-bottom: 10px; font-size: 1.2rem;">Today's Spiritual Insight</h4>
                                ${formatDailyInsight(insights.daily_insight)}
                            </div>
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #8b4513; margin-bottom: 10px; font-size: 1.2rem;">Cosmic Energy</h4>
                                <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 15px; background: rgba(139, 69, 19, 0.05); padding: 15px; border-radius: 10px; border: 1px solid rgba(139, 69, 19, 0.1);">
                                    <p style="margin: 0; font-weight: 600;"><span style="color: #8b4513;">Maya Day:</span> ${insights.cosmic_energy.maya_day}</p>
                                    <p style="margin: 0; font-weight: 600;"><span style="color: #8b4513;">Lunar Phase:</span> ${insights.cosmic_energy.lunar_phase}</p>
                                    <p style="margin: 0; font-weight: 600;"><span style="color: #8b4513;">Energy Level:</span> ${(insights.cosmic_energy.overall_intensity * 100).toFixed(1)}%</p>
                                </div>
                            </div>
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: #8b4513; margin-bottom: 10px; font-size: 1.2rem;">Recommended Practices</h4>
                                <div style="background: rgba(139, 69, 19, 0.05); padding: 15px; border-radius: 10px; border: 1px solid rgba(139, 69, 19, 0.1);">
                                    ${insights.recommended_practices.map(practice => `<p style="margin-bottom: 10px; padding: 8px; background: rgba(139, 69, 19, 0.1); border-radius: 5px; border-left: 3px solid #8b4513;">• ${practice}</p>`).join('')}
                                </div>
                            </div>
                            <div style="margin-top: 20px; text-align: center;">
                                <button onclick="document.getElementById('elementModal').style.display='none'" style="background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%); color: white; padding: 12px 25px; border: none; border-radius: 25px; font-weight: 600; cursor: pointer; margin-right: 10px;">Back to Dashboard</button>
                                <button onclick="shareCosmicElement('Daily Insights', 'Your personalized daily spiritual insights and cosmic energy reading')" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 12px 25px; border: none; border-radius: 25px; font-weight: 600; cursor: pointer;">Share Element</button>
                            </div>
                        </div>
                    `;
                } else {
                    modalBody.innerHTML = '<p>Error loading insights. Please try again.</p>';
                }
            } catch (error) {
                console.error('Error loading daily insights:', error);
                modalBody.innerHTML = '<p>Error loading insights. Please try again.</p>';
            }
        }

        // Guidance Request Modal Function
        async function showGuidanceRequest() {
            const modal = document.getElementById('elementModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = '🔮 Request Spiritual Guidance';
            modalBody.innerHTML = `
                <div style="line-height: 1.6; color: #1e3a8a;">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #8b4513;">Guidance Urgency:</label>
                        <select id="modalGuidanceUrgency" style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px;">
                            <option value="low">Gentle Guidance</option>
                            <option value="medium">Focused Guidance</option>
                            <option value="high">Urgent Guidance</option>
                            <option value="critical">Critical Support</option>
                        </select>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #8b4513;">Spiritual Theme:</label>
                        <select id="modalGuidanceTheme" style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px;">
                            <option value="transformation">Transformation</option>
                            <option value="healing">Healing</option>
                            <option value="manifestation">Manifestation</option>
                            <option value="clarity">Clarity</option>
                            <option value="protection">Protection</option>
                            <option value="love">Love & Relationships</option>
                            <option value="abundance">Abundance</option>
                            <option value="wisdom">Ancient Wisdom</option>
                        </select>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #8b4513;">Your Situation:</label>
                        <textarea id="modalCurrentSituation" placeholder="Describe your current situation or question..." style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #d1d5db; border-radius: 8px; min-height: 100px; resize: vertical; font-family: inherit; font-size: 16px;"></textarea>
                        <button onclick="requestModalGuidance()" style="background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%); color: white; padding: 12px 25px; border: none; border-radius: 25px; font-weight: 600; cursor: pointer; width: 100%; margin-bottom: 15px;">Request Guidance</button>
                    </div>
                    <div id="modalGuidanceResponse" style="display: none; margin-bottom: 20px;"></div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="document.getElementById('elementModal').style.display='none'" style="background: linear-gradient(135deg, #8b4513 0%, #a0522d 100%); color: white; padding: 12px 25px; border: none; border-radius: 25px; font-weight: 600; cursor: pointer;">Back to Dashboard</button>
                    </div>
                </div>
            `;
            modal.style.display = 'block';
        }

        // Request Guidance within Modal
        async function requestModalGuidance() {
            const urgency = document.getElementById('modalGuidanceUrgency').value;
            const theme = document.getElementById('modalGuidanceTheme').value;
            const situation = document.getElementById('modalCurrentSituation').value;
            
            if (!situation.trim()) {
                alert('Please describe your current situation or question.');
                return;
            }
            
            const responseDiv = document.getElementById('modalGuidanceResponse');
            responseDiv.style.display = 'block';
            responseDiv.innerHTML = '<div class="loading-indicator"><div class="loading-spinner"></div>Receiving spiritual guidance...</div>';
            
            try {
                const response = await fetch('/api/dynamic-spiritual-guidance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        urgency: urgency,
                        theme: theme,
                        current_situation: situation,
                        specific_question: situation,
                        emotional_state: "seeking guidance"
                    })
                });
                
                if (response.ok) {
                    const guidance = await response.json();
                    responseDiv.innerHTML = `
                        <div style="background: linear-gradient(135deg, #fef7ed 0%, #fef3c7 100%); padding: 20px; border-radius: 10px; border-left: 4px solid #8b4513;">
                            <h4 style="color: #8b4513; margin-bottom: 15px; font-size: 1.2rem;">Your Spiritual Guidance</h4>
                            <div style="margin-bottom: 15px;">
                                <p style="margin-bottom: 10px; line-height: 1.6;"><strong style="color: #8b4513;">Guidance:</strong> ${guidance.guidance}</p>
                                <p style="margin-bottom: 10px;"><strong style="color: #8b4513;">Confidence:</strong> ${(guidance.confidence_score * 100).toFixed(1)}%</p>
                                <p style="margin-bottom: 10px;"><strong style="color: #8b4513;">Cosmic Energy:</strong> ${guidance.cosmic_energy.maya_day} - ${guidance.cosmic_energy.lunar_phase}</p>
                            </div>
                            <div style="margin-top: 15px;">
                                <h5 style="color: #8b4513; margin-bottom: 10px; font-size: 1.1rem;">Recommended Practices:</h5>
                                <div style="background: rgba(139, 69, 19, 0.05); padding: 10px; border-radius: 8px;">
                                    ${guidance.recommended_practices.map(practice => `<p style="margin-bottom: 8px; padding: 5px; background: rgba(139, 69, 19, 0.1); border-radius: 5px;">• ${practice}</p>`).join('')}
                                </div>
                            </div>
                            <div style="margin-top: 20px; text-align: center;">
                                <button onclick="shareGuidanceContent('${guidance.guidance}', '${guidance.cosmic_energy.maya_day}', '${guidance.cosmic_energy.lunar_phase}')" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 12px 24px; border: none; border-radius: 25px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                                    🔗 Share Guidance
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // Track interaction
                    trackGuidanceInteraction(theme, urgency, guidance.confidence_score);
                } else {
                    responseDiv.innerHTML = '<p style="background: rgba(220, 38, 38, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #dc2626; color: #dc2626;">Unable to receive guidance at this time. Please try again.</p>';
                }
            } catch (error) {
                console.error('Error requesting guidance:', error);
                responseDiv.innerHTML = '<p style="background: rgba(220, 38, 38, 0.1); padding: 15px; border-radius: 8px; border-left: 4px solid #dc2626; color: #dc2626;">Error requesting guidance. Please try again.</p>';
            }
        }

        // Initialize Phase 3 Features (removed old loadDailyInsights call)
        function initializePhase3Features() {
            // Phase 3 features are now accessible via bubble cards
            console.log('Phase 3 features initialized - accessible via bubble cards');
        }

        // Initialize Phase 3 features when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Phase 3 features after a short delay
            setTimeout(() => {
                initializePhase3Features();
            }, 2000);
        });
    </script>
    
    <!-- Initialize Enhanced Cosmic Particles -->
    <script src="/static/js/cosmic-particles.js"></script>
    <script>
        // Initialize enhanced cosmic particles with user blueprint data
        function initializeDashboardCosmicParticles(userData) {
            if (typeof initCosmicParticles !== 'undefined') {
                const cosmicBlueprint = {
                    element: userData?.element || 'Fire',
                    galacticTone: userData?.galacticTone || 1,
                    daySign: userData?.daySign || 'Ahau',
                    lifePath: userData?.lifePath || 7,
                    kinNumber: userData?.kinNumber || 1,
                    direction: userData?.direction || 'South',
                    color: userData?.color || 'Red'
                };
                
                // Initialize enhanced 3D cosmic particle system
                initCosmicParticles('cosmic-particles-dashboard', cosmicBlueprint);
                
                console.log('Enhanced cosmic particles initialized with blueprint:', cosmicBlueprint);
            } else {
                console.warn('Enhanced cosmic particles system not available');
            }
        }
        
        // Initialize cosmic particles when user data is available
        function initializeCosmicParticlesWithUserData() {
            // Try to get user data from global variable if available
            if (typeof currentUserData !== 'undefined' && currentUserData) {
                initializeDashboardCosmicParticles(currentUserData);
            } else {
                // Initialize with default values if no user data yet
                initializeDashboardCosmicParticles(null);
            }
        }
        
        // Start cosmic particles after page load
        window.addEventListener('load', () => {
            // Phase 2 Performance Optimization - Initialize performance optimizations (SAFE)
            addOptimizedEventListeners();
            
            setTimeout(() => {
                initializeCosmicParticlesWithUserData();
            }, 1000); // Wait 1 second for user data to load
        });
        
        // Update cosmic particles when user data changes
        function updateCosmicParticlesWithUserData() {
            if (typeof currentUserData !== 'undefined' && currentUserData) {
                // Destroy existing particles and recreate with new data
                if (typeof destroyCosmicParticles !== 'undefined') {
                    destroyCosmicParticles('cosmic-particles-dashboard');
                }
                setTimeout(() => {
                    initializeDashboardCosmicParticles(currentUserData);
                }, 100);
            }
        }
    </script>
</body>
</html>